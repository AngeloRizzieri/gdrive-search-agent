<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drive Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* â”€â”€ Themes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:        #000000;
  --surface:   #0a0a0a;
  --raised:    #111111;
  --border:    #1c1c1c;
  --border-2:  #2a2a2a;
  --text:      #efefef;
  --text-2:    #808080;
  --text-3:    #383838;
  --accent:    #2563eb;
  --accent-bg: rgba(37,99,235,0.07);
  --accent-bd: rgba(37,99,235,0.22);
  --green:     #22c55e;
  --red:       #ef4444;
  --shadow:    0 0 0 1px rgba(255,255,255,0.04);
  --theme-icon: 'â˜€';
}
:root[data-theme="light"] {
  --bg:        #ffffff;
  --surface:   #fafafa;
  --raised:    #f2f2f2;
  --border:    #e8e8e8;
  --border-2:  #d4d4d4;
  --text:      #0a0a0a;
  --text-2:    #606060;
  --text-3:    #c0c0c0;
  --accent:    #2563eb;
  --accent-bg: rgba(37,99,235,0.06);
  --accent-bd: rgba(37,99,235,0.18);
  --green:     #16a34a;
  --red:       #dc2626;
  --shadow:    0 0 0 1px rgba(0,0,0,0.04);
  --theme-icon: 'â—';
}

html, body {
  height: 100%; background: var(--bg); color: var(--text);
  font-family: 'Inter', system-ui, sans-serif; font-size: 13px;
  line-height: 1.5; overflow: hidden; -webkit-font-smoothing: antialiased;
  transition: background 0.2s, color 0.2s;
}

/* â”€â”€ Login screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen {
  position: fixed; inset: 0; background: var(--bg);
  display: flex; align-items: center; justify-content: center; z-index: 100;
  transition: background 0.2s;
}
#login-screen.hidden { display: none; }
.login-card {
  display: flex; flex-direction: column; align-items: center; gap: 18px;
  padding: 44px 40px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; width: 320px; box-shadow: var(--shadow);
  transition: background 0.2s, border-color 0.2s;
}
.login-logo {
  width: 38px; height: 38px; background: var(--accent); border-radius: 8px;
  display: flex; align-items: center; justify-content: center; font-size: 16px;
}
.login-title { font-size: 15px; font-weight: 600; letter-spacing: -0.03em; }
.login-sub {
  font-size: 12px; color: var(--text-2); text-align: center;
  line-height: 1.65; font-weight: 400; max-width: 240px;
}
.login-btn {
  width: 100%; padding: 9px 0; background: var(--accent); border: none;
  border-radius: 6px; color: #fff; font-family: 'Inter', sans-serif;
  font-size: 12.5px; font-weight: 500; cursor: pointer;
  letter-spacing: -0.01em; transition: opacity 0.15s, transform 0.15s;
}
.login-btn:hover { opacity: 0.88; transform: translateY(-1px); }
.login-btn:active { transform: translateY(0); }

/* â”€â”€ App shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app { display: flex; flex-direction: column; height: 100vh; }
#app.hidden { display: none; }

/* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#topbar {
  height: 44px; display: flex; align-items: center;
  justify-content: space-between; padding: 0 16px;
  border-bottom: 1px solid var(--border); flex-shrink: 0;
  position: relative; z-index: 10; background: var(--bg);
  transition: border-color 0.2s, background 0.2s;
}
.brand { display: flex; align-items: center; gap: 8px; }
.brand-icon {
  width: 20px; height: 20px; background: var(--accent); border-radius: 4px;
  display: flex; align-items: center; justify-content: center; font-size: 10px;
}
.brand-name { font-size: 12.5px; font-weight: 600; letter-spacing: -0.02em; }
.tab-row {
  display: flex; gap: 1px; position: absolute; left: 50%; transform: translateX(-50%);
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; padding: 2px; transition: background 0.2s, border-color 0.2s;
}
.tab-btn {
  padding: 4px 14px; border: none; background: none; border-radius: 4px;
  color: var(--text-2); font-family: 'Inter', sans-serif; font-size: 11.5px;
  font-weight: 500; cursor: pointer; transition: all 0.15s; letter-spacing: -0.01em;
}
.tab-btn:hover:not(.active) { color: var(--text); background: rgba(255,255,255,0.03); }
.tab-btn.active { background: var(--raised); color: var(--text); box-shadow: var(--shadow); }
.topbar-right { display: flex; align-items: center; gap: 8px; }
.user-email { font-size: 10.5px; color: var(--text-2); font-family: 'JetBrains Mono', monospace; }
.topbar-btn {
  padding: 4px 9px; border: 1px solid var(--border); background: none;
  border-radius: 4px; color: var(--text-2); font-size: 11px; cursor: pointer;
  transition: all 0.15s; font-family: 'Inter', sans-serif; font-weight: 500;
}
.topbar-btn:hover { color: var(--text); border-color: var(--border-2); background: var(--raised); }
#theme-btn { font-size: 13px; padding: 3px 8px; }

/* â”€â”€ Tab panes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-pane { display: none; flex: 1; overflow: hidden; min-height: 0; }
.tab-pane.active { display: flex; }

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 220px; min-width: 220px; background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
  transition: background 0.2s, border-color 0.2s;
}
.sb-block {
  padding: 11px 12px 10px; border-bottom: 1px solid var(--border);
  transition: border-color 0.2s;
}
.sb-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.09em;
  text-transform: uppercase; color: var(--text-3); margin-bottom: 7px;
  transition: color 0.2s;
}
.sys-prompt-ta {
  width: 100%; background: var(--raised); border: 1px solid var(--border);
  border-radius: 4px; color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 9.5px; line-height: 1.55; padding: 6px 8px; resize: vertical;
  min-height: 80px; outline: none; transition: border-color 0.15s, background 0.2s;
}
.sys-prompt-ta:focus { border-color: var(--accent); }
.reset-btn {
  margin-top: 5px; font-size: 9px; color: var(--text-3); background: none;
  border: none; cursor: pointer; padding: 0; font-family: 'Inter', sans-serif;
  transition: color 0.15s;
}
.reset-btn:hover { color: var(--text-2); }
.model-select {
  width: 100%; background: var(--raised); border: 1px solid var(--border);
  border-radius: 4px; color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 10px; padding: 5px 26px 5px 7px; outline: none; cursor: pointer;
  transition: border-color 0.15s, background 0.2s; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='9' height='5'%3E%3Cpath d='M0 0l4.5 5L9 0z' fill='%23555'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 8px center;
}
.model-select:focus { border-color: var(--accent); }
.sb-files-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 11px 12px 5px;
}
.sb-files-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.09em;
  text-transform: uppercase; color: var(--text-3); transition: color 0.2s;
}
.sb-files-hint {
  font-size: 9px; color: var(--text-3); font-weight: 400; letter-spacing: 0;
  text-transform: none; transition: color 0.2s;
}
#files-scroll { flex: 1; overflow-y: auto; padding: 2px 5px 10px; }
#files-scroll::-webkit-scrollbar { width: 2px; }
#files-scroll::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 1px; }

/* â”€â”€ File rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.file-row {
  display: flex; align-items: center; gap: 7px; padding: 5px 7px;
  border-radius: 5px; cursor: pointer;
  transition: background 0.12s, border-color 0.12s;
  border: 1px solid transparent; margin-bottom: 1px;
}
.file-row:hover { background: var(--raised); }
.file-row.selected {
  background: var(--accent-bg) !important;
  border-color: var(--accent-bd);
}

/* â”€â”€ File type badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.f-type-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 8px; font-weight: 600; letter-spacing: 0.03em;
  padding: 1px 4px; border-radius: 3px; flex-shrink: 0;
  min-width: 28px; text-align: center; text-transform: uppercase;
  transition: opacity 0.15s;
}
.type-doc  { background: rgba(37,99,235,0.14);  color: #60a5fa; }
.type-xls  { background: rgba(34,197,94,0.14);  color: #4ade80; }
.type-ppt  { background: rgba(249,115,22,0.14); color: #fb923c; }
.type-pdf  { background: rgba(239,68,68,0.14);  color: #f87171; }
.type-fldr { background: rgba(234,179,8,0.14);  color: #fbbf24; }
.type-img  { background: rgba(168,85,247,0.14); color: #c084fc; }
.type-note { background: rgba(20,184,166,0.14); color: #2dd4bf; }
.type-txt  { background: rgba(148,163,184,0.12);color: #94a3b8; }
.type-file { background: rgba(107,114,128,0.10);color: var(--text-3); }
:root[data-theme="light"] .type-doc  { background: rgba(37,99,235,0.09);  color: #2563eb; }
:root[data-theme="light"] .type-xls  { background: rgba(22,163,74,0.09);  color: #16a34a; }
:root[data-theme="light"] .type-ppt  { background: rgba(234,88,12,0.09);  color: #ea580c; }
:root[data-theme="light"] .type-pdf  { background: rgba(220,38,38,0.09);  color: #dc2626; }
:root[data-theme="light"] .type-fldr { background: rgba(202,138,4,0.09);  color: #ca8a04; }
:root[data-theme="light"] .type-img  { background: rgba(147,51,234,0.09); color: #9333ea; }
:root[data-theme="light"] .type-note { background: rgba(15,118,110,0.09); color: #0f766e; }
:root[data-theme="light"] .type-txt  { background: rgba(71,85,105,0.09);  color: #475569; }

.f-name {
  font-size: 11px; color: var(--text-2); white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis; flex: 1;
  transition: color 0.12s;
}
.file-row:hover .f-name, .file-row.selected .f-name { color: var(--text); }

/* â”€â”€ Context bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#context-bar {
  display: none; flex-wrap: wrap; gap: 5px;
  padding: 6px 36px; align-items: center;
  border-top: 1px solid var(--border); background: var(--bg);
  flex-shrink: 0; transition: border-color 0.2s, background 0.2s;
}
#context-bar.has-files { display: flex; }
.ctx-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.09em;
  text-transform: uppercase; color: var(--text-3); flex-shrink: 0; margin-right: 2px;
}
.ctx-chip {
  display: flex; align-items: center; gap: 4px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 4px; padding: 2px 5px 2px 4px;
  max-width: 200px; transition: border-color 0.12s, background 0.12s;
  animation: chipIn 0.15s ease both;
}
@keyframes chipIn { from { opacity: 0; transform: scale(0.9) translateY(3px); } to { opacity: 1; transform: scale(1) translateY(0); } }
.ctx-chip:hover { border-color: var(--border-2); }
.ctx-chip-name {
  font-size: 11px; color: var(--text-2);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;
}
.ctx-chip-rm {
  background: none; border: none; color: var(--text-3);
  cursor: pointer; font-size: 14px; line-height: 1; padding: 0; flex-shrink: 0;
  transition: color 0.12s;
}
.ctx-chip-rm:hover { color: var(--red); }
.ctx-clear-btn {
  font-size: 9px; color: var(--text-3); background: none; border: none;
  cursor: pointer; padding: 2px 5px; font-family: 'Inter', sans-serif;
  transition: color 0.12s; margin-left: 2px; border-radius: 3px;
  letter-spacing: 0.02em;
}
.ctx-clear-btn:hover { color: var(--text-2); background: var(--raised); }

/* â”€â”€ Chat main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
#messages {
  flex: 1; overflow-y: auto; padding: 28px 36px 16px;
  display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth;
}
#messages::-webkit-scrollbar { width: 3px; }
#messages::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 2px; }
#empty-state {
  flex: 1; display: flex; align-items: center; justify-content: center;
  flex-direction: column; gap: 10px; color: var(--text-3); margin-top: -80px;
  pointer-events: none;
}
.empty-icon { font-size: 26px; opacity: 0.35; }
.empty-title { font-size: 13px; font-weight: 500; color: var(--text-2); letter-spacing: -0.01em; }
.empty-hints { display: flex; flex-direction: column; gap: 3px; align-items: center; }
.empty-hint {
  font-size: 11px; color: var(--text-3); letter-spacing: 0;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 4px; padding: 4px 10px; cursor: default;
}

/* â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.msg { display: flex; flex-direction: column; max-width: 78%; animation: fadeUp 0.2s ease-out both; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.msg.user { align-self: flex-end; align-items: flex-end; }
.msg.agent { align-self: flex-start; align-items: flex-start; }
.msg-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.09em;
  text-transform: uppercase; color: var(--text-3); margin-bottom: 4px; padding: 0 2px;
  transition: color 0.2s;
}
.msg.user .msg-label { color: var(--accent); opacity: 0.75; }
.bubble {
  padding: 10px 14px; border-radius: 7px; line-height: 1.72;
  font-size: 13px; font-weight: 400;
}
.msg.user .bubble {
  background: var(--accent-bg); border: 1px solid var(--accent-bd);
  color: var(--text); border-bottom-right-radius: 2px;
}
.msg.agent .bubble {
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text); border-bottom-left-radius: 2px;
  transition: background 0.2s, border-color 0.2s;
}
.bubble h1,.bubble h2,.bubble h3 { margin: 10px 0 4px; font-weight: 600; }
.bubble h1 { font-size: 15px; } .bubble h2 { font-size: 14px; } .bubble h3 { font-size: 13px; }
.bubble p { margin: 4px 0; }
.bubble ul,.bubble ol { padding-left: 16px; margin: 4px 0; }
.bubble li { margin: 2px 0; }
.bubble strong { font-weight: 600; }
.bubble code {
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  background: var(--raised); border: 1px solid var(--border);
  padding: 1px 5px; border-radius: 3px; color: var(--accent);
  transition: background 0.2s, border-color 0.2s;
}
.bubble pre {
  background: var(--raised); border: 1px solid var(--border);
  border-radius: 5px; padding: 12px; overflow-x: auto; margin: 8px 0;
  transition: background 0.2s, border-color 0.2s;
}
.bubble pre code { background: none; border: none; padding: 0; font-size: 11.5px; color: var(--text-2); }
.bubble a { color: var(--accent); text-decoration: none; border-bottom: 1px solid rgba(37,99,235,0.3); transition: border-color 0.15s; }
.bubble a:hover { border-bottom-color: var(--accent); }
.bubble hr { border: none; border-top: 1px solid var(--border); margin: 10px 0; }
.bubble blockquote { border-left: 2px solid var(--border-2); padding-left: 10px; color: var(--text-2); margin: 5px 0; }
.bubble table { border-collapse: collapse; width: 100%; margin: 8px 0; font-size: 12px; }
.bubble th, .bubble td { padding: 5px 10px; border: 1px solid var(--border); text-align: left; }
.bubble th { background: var(--raised); font-weight: 600; }
.msg-stats { display: flex; gap: 10px; margin-top: 5px; padding: 0 2px; }
.stat-item { font-family: 'JetBrains Mono', monospace; font-size: 9.5px; color: var(--text-3); }
.stat-item b { color: var(--text-2); font-weight: 500; }

/* â”€â”€ Thinking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.thinking { align-self: flex-start; animation: fadeUp 0.2s ease-out both; }
.thinking-inner {
  display: flex; align-items: center; gap: 8px; padding: 8px 12px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 7px; border-bottom-left-radius: 2px;
  transition: background 0.2s, border-color 0.2s;
}
.thinking-text { font-size: 11px; color: var(--text-2); font-family: 'JetBrains Mono', monospace; }
.dots span {
  display: inline-block; width: 3.5px; height: 3.5px; border-radius: 50%;
  background: var(--accent); animation: blink 1.2s ease-in-out infinite; margin: 0 1.5px;
}
.dots span:nth-child(2) { animation-delay: 0.2s; }
.dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%,80%,100%{opacity:.15;transform:scale(.75)} 40%{opacity:1;transform:scale(1)} }

/* â”€â”€ Input area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#input-area { padding: 6px 36px 16px; border-top: 1px solid var(--border); transition: border-color 0.2s; flex-shrink: 0; }
#input-row {
  display: flex; align-items: flex-end; gap: 7px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 7px; padding: 7px 9px;
  transition: border-color 0.15s, background 0.2s, box-shadow 0.15s;
}
#input-row:focus-within { border-color: var(--border-2); box-shadow: 0 0 0 3px rgba(37,99,235,0.06); }
#chat-input {
  flex: 1; background: none; border: none; outline: none; color: var(--text);
  font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 400;
  line-height: 1.5; resize: none; min-height: 20px; max-height: 120px;
}
#chat-input::placeholder { color: var(--text-3); }
#send-btn {
  width: 28px; height: 28px; background: var(--accent); border: none;
  border-radius: 5px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; flex-shrink: 0; transition: opacity 0.15s, transform 0.15s, background 0.15s;
}
#send-btn:hover:not(:disabled) { opacity: 0.86; transform: translateY(-1px); }
#send-btn:active:not(:disabled) { transform: translateY(0); }
#send-btn:disabled { background: var(--border-2); cursor: not-allowed; transform: none; opacity: 0.5; }
.input-hint { margin-top: 5px; font-size: 10px; color: var(--text-3); }
.input-hint kbd {
  display: inline-block; padding: 0 3px; border: 1px solid var(--border);
  border-radius: 3px; background: var(--surface); font-size: 9px;
  font-family: 'Inter', sans-serif; transition: background 0.2s, border-color 0.2s;
}

/* â”€â”€ Eval tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#tab-eval { background: var(--bg); overflow-y: auto; transition: background 0.2s; }
#eval-wrap { max-width: 820px; margin: 0 auto; padding: 32px 32px 80px; }
.eval-head { margin-bottom: 22px; }
.eval-title { font-size: 16px; font-weight: 600; letter-spacing: -0.03em; margin-bottom: 3px; }
.eval-sub { font-size: 11.5px; color: var(--text-2); font-weight: 400; }
.eval-section { margin-bottom: 20px; }
.eval-section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px; flex-wrap: wrap; gap: 8px;
}
.eval-section-left { display: flex; align-items: baseline; gap: 8px; }
.q-badge {
  font-size: 9.5px; font-family: 'JetBrains Mono', monospace;
  color: var(--text-3); background: var(--raised); border: 1px solid var(--border);
  border-radius: 3px; padding: 1px 6px;
}
.eval-section-right { display: flex; align-items: center; gap: 7px; }
.gen-btn {
  padding: 5px 11px; background: none; border: 1px solid var(--border);
  border-radius: 4px; color: var(--text-2); font-family: 'Inter', sans-serif;
  font-size: 11px; font-weight: 500; cursor: pointer;
  transition: all 0.15s;
}
.gen-btn:hover:not(:disabled) { color: var(--text); border-color: var(--border-2); background: var(--raised); }
.gen-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.save-btn {
  padding: 5px 11px; background: none; border: 1px solid var(--border);
  border-radius: 4px; color: var(--green); font-family: 'Inter', sans-serif;
  font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.15s;
}
.save-btn:hover { border-color: var(--green); background: rgba(34,197,94,0.05); }
#gen-status { font-family: 'JetBrains Mono', monospace; font-size: 9.5px; color: var(--text-2); }
#q-list {
  border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
  transition: border-color 0.2s;
}
.q-card {
  display: grid; grid-template-columns: 32px 1fr auto;
  background: var(--bg); border-bottom: 1px solid var(--border);
  transition: background 0.2s, border-color 0.2s;
}
.q-card:last-child { border-bottom: none; }
.q-card-num {
  display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  font-weight: 600; color: var(--text-3); background: var(--raised);
  border-right: 1px solid var(--border);
}
.q-card-fields { display: flex; flex-direction: column; }
.q-card-fields input {
  background: none; border: none; outline: none; color: var(--text);
  font-family: 'Inter', sans-serif; padding: 8px 11px; width: 100%;
  transition: background 0.12s;
}
.q-card-fields input:first-child { font-size: 12.5px; border-bottom: 1px solid var(--border); }
.q-card-fields input:last-child { font-size: 11.5px; color: var(--text-2); }
.q-card-fields input::placeholder { color: var(--text-3); }
.q-card-fields input:focus { background: var(--accent-bg); }
.q-card-del {
  display: flex; align-items: center; justify-content: center;
  padding: 0 11px; background: none; border: none;
  border-left: 1px solid var(--border); color: var(--text-3);
  cursor: pointer; font-size: 15px; line-height: 1;
  transition: color 0.12s, background 0.12s;
}
.q-card-del:hover { color: var(--red); background: rgba(239,68,68,0.06); }
.q-empty {
  padding: 24px; text-align: center; color: var(--text-3);
  font-size: 11.5px; background: var(--bg);
}
.q-add-btn {
  display: flex; align-items: center; gap: 5px; width: 100%;
  padding: 7px 12px; background: none;
  border: 1px dashed var(--border); border-radius: 4px;
  color: var(--text-3); font-family: 'Inter', sans-serif; font-size: 11px;
  cursor: pointer; transition: all 0.15s; margin-top: 6px;
}
.q-add-btn:hover { border-color: var(--border-2); color: var(--text-2); background: var(--raised); }
.eval-prompt-block { margin-bottom: 14px; }
.eval-prompt-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.none-toggle {
  display: flex; align-items: center; gap: 5px; cursor: pointer;
  font-size: 10px; color: var(--text-3); user-select: none;
  transition: color 0.12s;
}
.none-toggle input { accent-color: var(--accent); cursor: pointer; }
.none-toggle:hover { color: var(--text-2); }
.eval-prompt-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.09em;
  text-transform: uppercase; color: var(--text-3); margin-bottom: 6px;
}
.eval-prompt-ta {
  width: 100%; background: var(--surface); border: 1px solid var(--border);
  border-radius: 5px; color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 10.5px; line-height: 1.55; padding: 10px 11px;
  resize: vertical; min-height: 88px; outline: none;
  transition: border-color 0.15s, background 0.2s;
}
.eval-prompt-ta:focus { border-color: var(--accent); }
.compare-toggle-btn {
  font-size: 11px; color: var(--text-2); background: none;
  border: 1px dashed var(--border-2); border-radius: 4px;
  cursor: pointer; padding: 5px 12px; margin-bottom: 14px;
  font-family: 'Inter', sans-serif; font-weight: 500;
  transition: all 0.15s; display: inline-block;
}
.compare-toggle-btn:hover { color: var(--text); border-color: var(--text-3); background: var(--raised); }
.eval-controls { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; }
.eval-model-row { display: flex; align-items: center; gap: 8px; }
.eval-model-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.09em;
  text-transform: uppercase; color: var(--text-3); white-space: nowrap;
}
#run-btn {
  padding: 6px 14px; background: var(--accent); border: none; border-radius: 5px;
  color: #fff; font-family: 'Inter', sans-serif; font-size: 11.5px; font-weight: 600;
  cursor: pointer; transition: opacity 0.15s, transform 0.15s; letter-spacing: -0.01em;
}
#run-btn:hover:not(:disabled) { opacity: 0.86; transform: translateY(-1px); }
#run-btn:active:not(:disabled) { transform: translateY(0); }
#run-btn:disabled { opacity: 0.35; cursor: not-allowed; }
#eval-status-txt { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-2); }
.table-wrap {
  border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
  transition: border-color 0.2s;
}
.eval-tbl { width: 100%; border-collapse: collapse; font-size: 11.5px; }
.eval-tbl th {
  padding: 8px 12px; text-align: left; font-family: 'JetBrains Mono', monospace;
  font-size: 9px; font-weight: 500; letter-spacing: 0.09em; text-transform: uppercase;
  color: var(--text-3); background: var(--surface); border-bottom: 1px solid var(--border);
  white-space: nowrap; transition: background 0.2s, border-color 0.2s;
}
.eval-tbl th.r { text-align: right; }
.eval-tbl td { padding: 7px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; transition: border-color 0.2s, background 0.12s; }
.eval-tbl tr:last-child td { border-bottom: none; }
.eval-tbl tr:hover td { background: var(--surface); }
.td-id { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-3); }
.td-q { color: var(--text-2); max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.td-p { font-family: 'JetBrains Mono', monospace; font-size: 10px; white-space: nowrap; }
.td-p.p1 { color: #60a5fa; } .td-p.p2 { color: #c084fc; }
.td-ok { font-size: 11.5px; }
.td-n { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-2); text-align: right; white-space: nowrap; }
.td-n.better { color: var(--green); } .td-n.worse { color: var(--red); }
.sum-row td { background: var(--raised); border-top: 1px solid var(--border-2); }
.sum-row .td-n { color: var(--text); }
.tbl-empty { padding: 36px 0; text-align: center; color: var(--text-3); font-family: 'JetBrains Mono', monospace; font-size: 10.5px; }
.bubble.err { border-color: rgba(239,68,68,0.3); color: var(--red); }
/* â”€â”€ Eval row detail drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.data-row { cursor: pointer; }
.data-row td { transition: background 0.1s, border-color 0.2s; }
.data-row:hover td { background: var(--raised) !important; }
.data-row.open td { background: var(--surface) !important; }
.detail-row { display: none; }
.detail-row.open { display: table-row; }
.detail-row td { padding: 0; background: var(--surface); border-bottom: 1px solid var(--border-2); }
.detail-box {
  padding: 12px 16px 14px; display: grid; grid-template-columns: auto 1fr 1fr;
  gap: 0 18px; align-items: start;
}
.detail-chevron {
  font-size: 9px; color: var(--text-3); padding-top: 13px;
  transition: transform 0.15s;
}
.data-row.open .detail-chevron { transform: rotate(90deg); }
.detail-col { display: flex; flex-direction: column; gap: 4px; padding: 8px 0; }
.detail-label { font-size: 9px; font-weight: 600; letter-spacing: 0.09em; text-transform: uppercase; color: var(--text-3); }
.detail-val { font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.6; color: var(--text-2); white-space: pre-wrap; word-break: break-word; }
.detail-val.pass { color: var(--green); }
.detail-val.fail { color: var(--red); }

/* â”€â”€ Accessibility: respect reduced-motion preference â”€â”€â”€â”€â”€â”€â”€ */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  html, body { transition: none !important; }
  #messages { scroll-behavior: auto; }
}

/* â”€â”€ Fluid typography: clamp() for responsive scales â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --text-base: clamp(12px, 1.1vw, 13.5px);
  --text-sm:   clamp(10px, 0.9vw, 11.5px);
  --text-xs:   clamp(9px, 0.75vw, 10px);
}
.bubble { font-size: var(--text-base); }
.f-name, .ctx-chip-name { font-size: var(--text-sm); }
.msg-label, .sb-label, .eval-prompt-label, .sb-files-label { font-size: var(--text-xs); }
</style>
</head>
<body>

<!-- â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">âŒ–</div>
    <div class="login-title">Drive Agent</div>
    <div class="login-sub">Search and chat with your Google Drive files using AI.</div>
    <button class="login-btn" onclick="location.href='/auth/login'">Sign in with Google</button>
  </div>
</div>

<!-- â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app" class="hidden">

  <div id="topbar">
    <div class="brand">
      <div class="brand-icon">âŒ–</div>
      <span class="brand-name">Drive Agent</span>
    </div>
    <div class="tab-row">
      <button class="tab-btn active" onclick="switchTab('chat')">Chat</button>
      <button class="tab-btn" onclick="switchTab('eval')">Eval</button>
    </div>
    <div class="topbar-right">
      <span class="user-email" id="user-email"></span>
      <button id="theme-btn" class="topbar-btn" onclick="toggleTheme()" title="Toggle theme">â—</button>
      <button class="topbar-btn" onclick="location.href='/auth/logout'">Sign out</button>
    </div>
  </div>

  <!-- CHAT TAB -->
  <div id="tab-chat" class="tab-pane active">
    <aside id="sidebar">
      <div class="sb-block">
        <div class="sb-label">Model</div>
        <select id="chat-model" class="model-select">
          <option value="claude-sonnet-4-6">Sonnet 4.6</option>
          <option value="claude-haiku-4-5-20251001">Haiku 4.5</option>
          <option value="claude-opus-4-6">Opus 4.6</option>
        </select>
      </div>
      <div class="sb-block">
        <div class="sb-label">System Prompt</div>
        <textarea id="system-prompt-input" class="sys-prompt-ta" spellcheck="false" placeholder="No system prompt â€” type to add oneâ€¦"></textarea>
        <div style="display:flex;gap:8px;margin-top:5px">
          <button class="reset-btn" onclick="resetToDefault()" id="reset-default-btn">Reset to default</button>
          <button class="reset-btn" onclick="clearPrompt()" style="color:var(--red);opacity:0.7" id="clear-prompt-btn">Clear</button>
        </div>
      </div>
      <div class="sb-files-header">
        <span class="sb-files-label">Files</span>
        <span class="sb-files-hint">click to add context</span>
      </div>
      <div id="files-scroll">
        <div style="font-size:10.5px;color:var(--text-3);padding:6px 7px;">Loadingâ€¦</div>
      </div>
    </aside>

    <main id="chat-main">
      <div id="messages">
        <div id="empty-state">
          <div class="empty-icon">ğŸ—‚</div>
          <div class="empty-title">Ask anything about your Google Drive</div>
          <div class="empty-hints">
            <div class="empty-hint">What's in my latest document?</div>
            <div class="empty-hint">Find files about project X</div>
            <div class="empty-hint">Summarise my notes from last week</div>
          </div>
        </div>
      </div>
      <div id="context-bar"></div>
      <div id="input-area">
        <div id="input-row">
          <textarea id="chat-input" rows="1" placeholder="Ask about your Driveâ€¦"></textarea>
          <button id="send-btn" onclick="sendMessage()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
        <div class="input-hint"><kbd>Enter</kbd> send Â· <kbd>Shift+Enter</kbd> newline</div>
      </div>
    </main>
  </div>

  <!-- EVAL TAB -->
  <div id="tab-eval" class="tab-pane">
    <div id="eval-wrap">
      <div class="eval-head">
        <div class="eval-title">Eval Runner</div>
        <div class="eval-sub">Test 1 or 2 system prompts against your question set and compare token cost and accuracy.</div>
      </div>

      <!-- Question set -->
      <div class="eval-section">
        <div class="eval-section-header">
          <div class="eval-section-left">
            <div class="eval-prompt-label">Question Set</div>
            <span id="q-badge" class="q-badge">loadingâ€¦</span>
          </div>
          <div class="eval-section-right">
            <span id="gen-status"></span>
            <select id="gen-count" class="model-select" style="width:auto">
              <option value="3">3 Qs</option>
              <option value="5" selected>5 Qs</option>
              <option value="10">10 Qs</option>
            </select>
            <button class="gen-btn" id="gen-btn" onclick="generateQuestions()">Generate with AI</button>
            <button class="save-btn" onclick="saveQuestions()">Save</button>
          </div>
        </div>
        <div id="q-list"></div>
        <button class="q-add-btn" onclick="addQuestion()">+ Add question</button>
      </div>
      <hr style="border:none;border-top:1px solid var(--border);margin-bottom:20px">

      <div class="eval-prompt-block">
        <div class="eval-prompt-header">
          <div class="eval-prompt-label">Prompt 1</div>
          <label class="none-toggle"><input type="checkbox" id="p1-none" onchange="toggleNone('eval-p1','p1-none')"> No system prompt</label>
        </div>
        <textarea id="eval-p1" class="eval-prompt-ta" spellcheck="false" placeholder="Optional system prompt â€” leave blank or check 'No system prompt'â€¦"></textarea>
      </div>

      <button class="compare-toggle-btn" id="compare-btn" onclick="toggleCompare()">+ Compare with a second prompt</button>

      <div class="eval-prompt-block" id="eval-p2-block" style="display:none">
        <div class="eval-prompt-header">
          <div class="eval-prompt-label">Prompt 2</div>
          <label class="none-toggle"><input type="checkbox" id="p2-none" onchange="toggleNone('eval-p2','p2-none')"> No system prompt</label>
        </div>
        <textarea id="eval-p2" class="eval-prompt-ta" spellcheck="false" placeholder="Optional system prompt â€” leave blank or check 'No system prompt'â€¦"></textarea>
      </div>

      <div class="eval-controls">
        <button id="run-btn" onclick="runEval()">Run Eval</button>
        <div class="eval-model-row">
          <span class="eval-model-label">Model</span>
          <select id="eval-model" class="model-select" style="width:auto;min-width:148px">
            <option value="claude-sonnet-4-6">Sonnet 4.6</option>
            <option value="claude-haiku-4-5-20251001">Haiku 4.5</option>
            <option value="claude-opus-4-6">Opus 4.6</option>
          </select>
        </div>
        <span id="eval-status-txt"></span>
      </div>

      <div class="table-wrap">
        <table class="eval-tbl">
          <thead>
            <tr>
              <th></th><th>ID</th><th>Question</th><th>Prompt</th><th>Pass</th>
              <th class="r">In Tok</th><th class="r">Out Tok</th>
              <th class="r">Tools</th><th class="r">Turns</th>
            </tr>
          </thead>
          <tbody id="eval-tbody">
            <tr><td colspan="9" class="tbl-empty">Run an eval to see results.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const html = document.documentElement;
  const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next;
  document.getElementById('theme-btn').textContent = next === 'dark' ? 'â—' : 'â˜€';
  localStorage.setItem('theme', next);
}
(function() {
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.dataset.theme = saved;
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('theme-btn');
    if (btn) btn.textContent = saved === 'dark' ? 'â—' : 'â˜€';
  });
})();

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chatBusy = false, evalRunning = false, compareMode = false;
let evalResults = { "1": [], "2": [] };
let contextFiles = []; // [{id, name, mime}]

// â”€â”€ File type labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TYPE_LABELS = {
  'application/vnd.google-apps.document':     { label: 'DOC',  cls: 'type-doc' },
  'application/vnd.google-apps.spreadsheet':  { label: 'XLS',  cls: 'type-xls' },
  'application/vnd.google-apps.presentation': { label: 'PPT',  cls: 'type-ppt' },
  'application/vnd.google-apps.form':         { label: 'FORM', cls: 'type-ppt' },
  'application/vnd.google-apps.drawing':      { label: 'DRAW', cls: 'type-doc' },
  'application/vnd.google-apps.folder':       { label: 'FLDR', cls: 'type-fldr' },
  'application/pdf':                          { label: 'PDF',  cls: 'type-pdf' },
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document':  { label: 'DOC', cls: 'type-doc' },
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet':        { label: 'XLS', cls: 'type-xls' },
  'application/vnd.openxmlformats-officedocument.presentationml.presentation':{ label: 'PPT', cls: 'type-ppt' },
  'image/jpeg': { label: 'IMG', cls: 'type-img' },
  'image/png':  { label: 'IMG', cls: 'type-img' },
  'image/gif':  { label: 'GIF', cls: 'type-img' },
  'image/webp': { label: 'IMG', cls: 'type-img' },
  'text/plain': { label: 'TXT', cls: 'type-txt' },
  'text/csv':   { label: 'CSV', cls: 'type-xls' },
  'text/markdown': { label: 'MD', cls: 'type-txt' },
};

function typeInfo(mime, name) {
  if (TYPE_LABELS[mime]) return TYPE_LABELS[mime];
  if (mime) {
    if (mime.startsWith('image/')) return { label: 'IMG', cls: 'type-img' };
    if (mime.startsWith('video/')) return { label: 'VID', cls: 'type-file' };
    if (mime.startsWith('audio/')) return { label: 'AUD', cls: 'type-file' };
    if (mime.includes('note'))     return { label: 'NOTE', cls: 'type-note' };
  }
  // Fallback: detect by filename extension for ambiguous types (e.g. HEIC as octet-stream)
  if (name) {
    const ext = name.split('.').pop().toLowerCase();
    if (['heic','heif','jpg','jpeg','png','gif','webp','bmp','tiff'].includes(ext))
      return { label: 'IMG', cls: 'type-img' };
    if (['mp4','mov','avi','mkv','webm'].includes(ext))
      return { label: 'VID', cls: 'type-file' };
    if (['note'].includes(ext))
      return { label: 'NOTE', cls: 'type-note' };
    if (['pdf'].includes(ext))
      return { label: 'PDF', cls: 'type-pdf' };
    if (['doc','docx'].includes(ext))
      return { label: 'DOC', cls: 'type-doc' };
    if (['xls','xlsx','csv'].includes(ext))
      return { label: 'XLS', cls: 'type-xls' };
  }
  return { label: 'FILE', cls: 'type-file' };
}

// â”€â”€ System prompt state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _defaultPromptText = '';

async function loadDefaultPrompt() {
  try {
    const r = await fetch('/api/default-prompt');
    const d = await r.json();
    _defaultPromptText = d.prompt || '';
  } catch {}
}

function _initSystemPrompt() {
  const ta = document.getElementById('system-prompt-input');
  const saved = localStorage.getItem('system-prompt');
  // Restore whatever the user last had (empty string = intentionally no prompt)
  ta.value = saved !== null ? saved : '';
  _updatePromptButtons();
  ta.addEventListener('input', () => {
    localStorage.setItem('system-prompt', ta.value);
    _updatePromptButtons();
  });
}

function _updatePromptButtons() {
  const ta = document.getElementById('system-prompt-input');
  const isDefault = ta.value.trim() === _defaultPromptText.trim();
  const isEmpty = ta.value.trim() === '';
  document.getElementById('reset-default-btn').style.opacity = isDefault ? '0.35' : '1';
  document.getElementById('reset-default-btn').disabled = isDefault;
  document.getElementById('clear-prompt-btn').style.opacity = isEmpty ? '0.35' : '1';
  document.getElementById('clear-prompt-btn').disabled = isEmpty;
}

function resetToDefault() {
  const ta = document.getElementById('system-prompt-input');
  ta.value = _defaultPromptText;
  localStorage.setItem('system-prompt', _defaultPromptText);
  _updatePromptButtons();
}

function clearPrompt() {
  const ta = document.getElementById('system-prompt-input');
  ta.value = '';
  localStorage.setItem('system-prompt', '');
  _updatePromptButtons();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  await loadDefaultPrompt();
  const res = await fetch('/auth/status');
  const data = await res.json();
  if (!data.authenticated) {
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
  } else {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('user-email').textContent = data.email || '';
    _initSystemPrompt();
    loadFiles();
    loadQuestions();
    document.getElementById('chat-input').focus();
  }
}

// â”€â”€ Questions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _questions = [];

function _setQBadge(questions) {
  document.getElementById('q-badge').textContent = `${questions.length} question${questions.length !== 1 ? 's' : ''}`;
}

function renderQuestions(qs) {
  _questions = qs.map(q => ({ ...q }));
  const list = document.getElementById('q-list');
  if (!_questions.length) {
    list.innerHTML = '<div class="q-empty">No questions yet â€” add one or generate with AI.</div>';
  } else {
    list.innerHTML = _questions.map((q, i) => `
      <div class="q-card">
        <div class="q-card-num">${i + 1}</div>
        <div class="q-card-fields">
          <input type="text" placeholder="Questionâ€¦" value="${esc(q.question || '')}" oninput="_questions[${i}].question=this.value">
          <input type="text" placeholder="Expected answerâ€¦" value="${esc(q.expected_answer || '')}" oninput="_questions[${i}].expected_answer=this.value">
        </div>
        <button class="q-card-del" title="Remove" onclick="removeQuestion(${i})">Ã—</button>
      </div>`).join('');
  }
  _setQBadge(_questions);
}

function addQuestion() {
  _questions.push({ id: `q${_questions.length + 1}`, question: '', expected_answer: '' });
  renderQuestions(_questions);
  const cards = document.querySelectorAll('.q-card');
  if (cards.length) cards[cards.length - 1].querySelector('input')?.focus();
}

function removeQuestion(i) {
  _questions.splice(i, 1);
  _questions.forEach((q, idx) => { if (!q.id || /^q\d+$/.test(q.id)) q.id = `q${idx + 1}`; });
  renderQuestions(_questions);
}

function getQuestions() {
  return _questions.filter(q => (q.question || '').trim());
}

async function loadQuestions() {
  try {
    const r = await fetch('/eval/questions');
    const d = await r.json();
    renderQuestions(d.questions || []);
  } catch {
    document.getElementById('q-badge').textContent = 'error';
  }
}

async function saveQuestions() {
  const qs = getQuestions();
  try {
    const r = await fetch('/eval/questions', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ questions: qs })
    });
    const d = await r.json();
    if (d.error) { alert('Save failed: ' + d.error); return; }
    _setQBadge(qs);
    const btn = document.querySelector('.save-btn');
    const orig = btn.textContent; btn.textContent = 'Saved âœ“';
    setTimeout(() => btn.textContent = orig, 1500);
  } catch (e) { alert('Save error: ' + e.message); }
}

async function generateQuestions() {
  const genBtn = document.getElementById('gen-btn');
  const status = document.getElementById('gen-status');
  const count = document.getElementById('gen-count').value;
  const model = document.getElementById('eval-model').value;
  genBtn.disabled = true;
  status.textContent = 'generatingâ€¦';
  try {
    const res = await fetch('/eval/generate-questions', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ count: parseInt(count), model })
    });
    const reader = res.body.getReader(), dec = new TextDecoder();
    let buf = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });
      const lines = buf.split('\n'); buf = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const ev = JSON.parse(line.slice(6));
          if (ev.type === 'thinking') { status.textContent = 'browsing driveâ€¦'; }
          else if (ev.type === 'done') {
            renderQuestions(ev.questions);
            const t = ev.tokens;
            status.textContent = `done Â· ${t?.input_tokens?.toLocaleString()} in / ${t?.output_tokens?.toLocaleString()} out`;
          } else if (ev.type === 'error') {
            status.textContent = 'error: ' + ev.payload;
          }
        } catch {}
      }
    }
  } catch (e) { status.textContent = 'error: ' + e.message; }
  finally { genBtn.disabled = false; }
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(t) {
  document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + t).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(el => {
    if (el.textContent.toLowerCase() === t) el.classList.add('active');
  });
}

// â”€â”€ Prompt helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleNone(taId, cbId) {
  const ta = document.getElementById(taId);
  const checked = document.getElementById(cbId).checked;
  ta.disabled = checked;
  ta.style.opacity = checked ? '0.35' : '1';
}

function toggleCompare() {
  compareMode = !compareMode;
  document.getElementById('eval-p2-block').style.display = compareMode ? '' : 'none';
  document.getElementById('compare-btn').textContent = compareMode
    ? 'âˆ’ Remove second prompt'
    : '+ Compare with a second prompt';
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ File context chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFileContext(id, name, mime, rowEl) {
  const idx = contextFiles.findIndex(f => f.id === id);
  if (idx >= 0) {
    contextFiles.splice(idx, 1);
    rowEl.classList.remove('selected');
  } else {
    contextFiles.push({ id, name, mime });
    rowEl.classList.add('selected');
  }
  renderContextChips();
}

function removeFileContext(id) {
  contextFiles = contextFiles.filter(f => f.id !== id);
  const row = document.querySelector(`.file-row[data-id="${CSS.escape(id)}"]`);
  if (row) row.classList.remove('selected');
  renderContextChips();
}

function clearAllContext() {
  contextFiles = [];
  document.querySelectorAll('.file-row.selected').forEach(r => r.classList.remove('selected'));
  renderContextChips();
}

function renderContextChips() {
  const bar = document.getElementById('context-bar');
  if (!contextFiles.length) {
    bar.classList.remove('has-files');
    bar.innerHTML = '';
    return;
  }
  bar.classList.add('has-files');
  const chips = contextFiles.map(f => {
    const ti = typeInfo(f.mime, f.name);
    return `<div class="ctx-chip">
      <span class="f-type-badge ${ti.cls}">${ti.label}</span>
      <span class="ctx-chip-name">${esc(f.name)}</span>
      <button class="ctx-chip-rm" onclick="removeFileContext('${esc(f.id)}')" title="Remove from context">Ã—</button>
    </div>`;
  }).join('');
  bar.innerHTML = `<span class="ctx-label">Context</span>${chips}<button class="ctx-clear-btn" onclick="clearAllContext()">clear all</button>`;
}

// â”€â”€ Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFiles() {
  const el = document.getElementById('files-scroll');
  try {
    const r = await fetch('/files');
    if (r.status === 401) { el.innerHTML = ''; return; }
    const d = await r.json();
    const files = d.files || [];
    if (!files.length) {
      el.innerHTML = '<div style="font-size:10.5px;color:var(--text-3);padding:6px 7px">No files found.</div>';
      return;
    }
    el.innerHTML = files.map(f => {
      const ti = typeInfo(f.mimeType, f.name);
      return `<div class="file-row" data-id="${esc(f.id)}" data-name="${esc(f.name)}" data-mime="${esc(f.mimeType)}" title="${esc(f.name)}">
        <span class="f-type-badge ${ti.cls}">${ti.label}</span>
        <span class="f-name">${esc(f.name)}</span>
      </div>`;
    }).join('');
  } catch {
    el.innerHTML = '<div style="font-size:10.5px;color:var(--text-3);padding:6px 7px">Error loading.</div>';
  }
}

// Event delegation for file row clicks
document.getElementById('files-scroll').addEventListener('click', function(e) {
  const row = e.target.closest('.file-row');
  if (!row) return;
  toggleFileContext(row.dataset.id, row.dataset.name, row.dataset.mime, row);
});

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollBottom() {
  const m = document.getElementById('messages');
  m.scrollTop = m.scrollHeight;
}

function appendUser(text) {
  document.getElementById('empty-state')?.remove();
  const d = document.createElement('div');
  d.className = 'msg user';
  d.innerHTML = `<div class="msg-label">you</div><div class="bubble">${esc(text)}</div>`;
  document.getElementById('messages').appendChild(d);
  scrollBottom();
}

function showThinking() {
  const d = document.createElement('div');
  d.className = 'thinking'; d.id = 'thinking';
  d.innerHTML = `<div class="thinking-inner">
    <span class="thinking-text">thinking</span>
    <div class="dots"><span></span><span></span><span></span></div>
  </div>`;
  document.getElementById('messages').appendChild(d);
  scrollBottom();
}

function removeThinking() { document.getElementById('thinking')?.remove(); }

function appendAgent(answer, stats) {
  const statsHtml = stats ? `<div class="msg-stats">
    <span class="stat-item"><b>${stats.input_tokens.toLocaleString()}</b> in</span>
    <span class="stat-item"><b>${stats.output_tokens.toLocaleString()}</b> out</span>
    <span class="stat-item"><b>${stats.tool_calls}</b> tools</span>
    <span class="stat-item"><b>${stats.turns}</b> turns</span>
  </div>` : '';
  const d = document.createElement('div');
  d.className = 'msg agent';
  d.innerHTML = `<div class="msg-label">agent</div><div class="bubble">${marked.parse(answer)}</div>${statsHtml}`;
  document.getElementById('messages').appendChild(d);
  scrollBottom();
}

function appendError(msg) {
  const d = document.createElement('div');
  d.className = 'msg agent';
  d.innerHTML = `<div class="msg-label" style="color:var(--red)">error</div>
    <div class="bubble err">${esc(msg)}</div>`;
  document.getElementById('messages').appendChild(d);
  scrollBottom();
}

function setDisabled(v) {
  chatBusy = v;
  document.getElementById('chat-input').disabled = v;
  document.getElementById('send-btn').disabled = v;
}

async function sendMessage() {
  if (chatBusy) return;
  const input = document.getElementById('chat-input');
  const q = input.value.trim();
  if (!q) return;
  const systemPrompt = document.getElementById('system-prompt-input').value.trim();
  const model = document.getElementById('chat-model').value;

  // Build instrumented question with context file preamble
  let question = q;
  if (contextFiles.length) {
    const fileList = contextFiles.map(f => `"${f.name}" (id: ${f.id})`).join(', ');
    question = `Read these files for context first: ${fileList}. Then answer: ${q}`;
  }

  input.value = ''; input.style.height = 'auto';
  appendUser(q); // show original question in UI
  setDisabled(true); showThinking();
  try {
    const res = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question, system_prompt: systemPrompt, model })
    });
    if (res.status === 401) { removeThinking(); appendError('Session expired. Please sign in again.'); setDisabled(false); return; }
    const reader = res.body.getReader(), dec = new TextDecoder();
    let buf = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });
      const lines = buf.split('\n'); buf = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const ev = JSON.parse(line.slice(6));
          if (ev.type === 'done') { removeThinking(); appendAgent(ev.payload.answer, ev.payload); }
          else if (ev.type === 'error') { removeThinking(); appendError(ev.payload); }
        } catch {}
      }
    }
  } catch (e) { removeThinking(); appendError('Connection error: ' + e.message); }
  finally { setDisabled(false); document.getElementById('chat-input').focus(); }
}

// â”€â”€ Eval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cmp(val, other) {
  if (val == null || other == null) return '';
  return val < other ? 'better' : val > other ? 'worse' : '';
}

function toggleDetail(key) {
  const dataRow = document.getElementById('dr-' + key);
  const detailRow = document.getElementById('detail-' + key);
  if (!dataRow || !detailRow) return;
  const isOpen = detailRow.classList.contains('open');
  detailRow.classList.toggle('open', !isOpen);
  dataRow.classList.toggle('open', !isOpen);
}

function renderTable() {
  const tbody = document.getElementById('eval-tbody');
  const r1 = evalResults["1"], r2 = evalResults["2"];
  const ids = [...new Set([...r1, ...r2].map(r => r.id))];
  if (!ids.length) { tbody.innerHTML = '<tr><td colspan="9" class="tbl-empty">No results yet.</td></tr>'; return; }

  let html = '';
  for (const id of ids) {
    const ra = r1.find(r => r.id === id), rb = r2.find(r => r.id === id);
    for (const [lbl, r] of [['1', ra], ['2', rb]]) {
      if (!r) continue;
      const other = lbl === '1' ? rb : ra;
      const key = `${id}-${lbl}`;
      const expected = esc(r.expected_answer || 'â€”');
      const got = esc(r.response || r.error || 'â€”');
      const gotClass = r.correct ? 'pass' : 'fail';
      html += `
      <tr class="data-row" id="dr-${key}" onclick="toggleDetail('${key}')">
        <td style="width:18px;padding:7px 4px 7px 10px"><span class="detail-chevron">â–¶</span></td>
        <td class="td-id">${esc(r.id)}</td>
        <td class="td-q" title="${esc(r.question)}">${esc(r.question)}</td>
        <td class="td-p p${lbl}">${lbl}</td>
        <td class="td-ok">${r.correct ? 'âœ“' : 'âœ—'}</td>
        <td class="td-n ${cmp(r.input_tokens, other?.input_tokens)}">${r.input_tokens.toLocaleString()}</td>
        <td class="td-n ${cmp(r.output_tokens, other?.output_tokens)}">${r.output_tokens.toLocaleString()}</td>
        <td class="td-n ${cmp(r.tool_calls, other?.tool_calls)}">${r.tool_calls}</td>
        <td class="td-n ${cmp(r.turns, other?.turns)}">${r.turns}</td>
      </tr>
      <tr class="detail-row" id="detail-${key}">
        <td colspan="9">
          <div class="detail-box">
            <div></div>
            <div class="detail-col">
              <div class="detail-label">Expected</div>
              <div class="detail-val">${expected}</div>
            </div>
            <div class="detail-col">
              <div class="detail-label">Got</div>
              <div class="detail-val ${gotClass}">${got}</div>
            </div>
          </div>
        </td>
      </tr>`;
    }
  }

  const avg = (rs, k) => rs.length ? rs.reduce((s,r) => s+(r[k]||0),0)/rs.length : null;
  const pct = rs => rs.length ? Math.round(rs.filter(r=>r.correct).length/rs.length*100)+'%' : 'â€”';

  for (const [lbl, rs] of [['1', r1], ['2', r2]]) {
    if (!rs.length) continue;
    const other = lbl === '1' ? r2 : r1;
    html += `<tr class="sum-row">
      <td></td>
      <td class="td-id">avg</td>
      <td style="font-size:11px;color:var(--text-2)">Summary</td>
      <td class="td-p p${lbl}">${lbl}</td>
      <td style="font-size:11.5px;font-weight:600">${pct(rs)}</td>
      <td class="td-n ${cmp(avg(rs,'input_tokens'),avg(other,'input_tokens'))}">${Math.round(avg(rs,'input_tokens')).toLocaleString()}</td>
      <td class="td-n ${cmp(avg(rs,'output_tokens'),avg(other,'output_tokens'))}">${Math.round(avg(rs,'output_tokens')).toLocaleString()}</td>
      <td class="td-n ${cmp(avg(rs,'tool_calls'),avg(other,'tool_calls'))}">${avg(rs,'tool_calls').toFixed(1)}</td>
      <td class="td-n ${cmp(avg(rs,'turns'),avg(other,'turns'))}">${avg(rs,'turns').toFixed(1)}</td>
    </tr>`;
  }
  tbody.innerHTML = html;
}

async function runEval() {
  if (evalRunning) return;
  evalRunning = true;
  evalResults = { "1": [], "2": [] };
  document.getElementById('run-btn').disabled = true;
  document.getElementById('eval-tbody').innerHTML = '<tr><td colspan="9" class="tbl-empty">Runningâ€¦</td></tr>';
  const status = document.getElementById('eval-status-txt');
  status.textContent = 'startingâ€¦';

  const p1 = document.getElementById('p1-none').checked ? '' : document.getElementById('eval-p1').value.trim();
  const prompts = [p1];
  if (compareMode) {
    const p2 = document.getElementById('p2-none').checked ? '' : document.getElementById('eval-p2').value.trim();
    prompts.push(p2);
  }
  const model = document.getElementById('eval-model').value;
  const inlineQuestions = getQuestions().length ? getQuestions() : null;

  try {
    const res = await fetch('/eval', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompts, model, questions: inlineQuestions })
    });
    if (res.status === 401) { status.textContent = 'sign in required'; return; }
    const reader = res.body.getReader(), dec = new TextDecoder();
    let buf = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });
      const lines = buf.split('\n'); buf = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const ev = JSON.parse(line.slice(6));
          if (ev.type === 'result') {
            evalResults[ev.prompt].push(ev);
            status.textContent = `${model} Â· ${ev.id} Â· prompt ${ev.prompt} Â· ${ev.correct ? 'pass' : 'fail'}`;
            renderTable();
          } else if (ev.type === 'done') {
            status.textContent = 'complete';
          }
        } catch {}
      }
    }
  } catch (e) { status.textContent = 'error: ' + e.message; }
  finally { evalRunning = false; document.getElementById('run-btn').disabled = false; }
}

// â”€â”€ Input auto-resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('chat-input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
document.getElementById('chat-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

init();
</script>
</body>
</html>
