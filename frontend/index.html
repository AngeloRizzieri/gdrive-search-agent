<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drive Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fragment+Mono&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0d0d0d;
    --surface: #141414;
    --card: #1a1a1a;
    --border: #242424;
    --accent: #4f8ef7;
    --accent-dim: rgba(79,142,247,0.12);
    --accent-glow: rgba(79,142,247,0.25);
    --text: #e8e8e8;
    --muted: #666;
    --muted-light: #888;
    --mono: 'Fragment Mono', 'Courier New', monospace;
    --sans: 'DM Sans', system-ui, sans-serif;
    --sidebar-w: 272px;
    --radius: 10px;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    font-size: 14px;
    line-height: 1.6;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
  #app {
    display: flex;
    height: 100vh;
    position: relative;
  }

  /* ‚îÄ‚îÄ Subtle dot grid bg ‚îÄ‚îÄ */
  #app::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: radial-gradient(circle, #2a2a2a 1px, transparent 1px);
    background-size: 28px 28px;
    opacity: 0.35;
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  #sidebar {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 1;
    overflow: hidden;
  }

  #sidebar-header {
    padding: 22px 20px 18px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 30px;
    height: 30px;
    background: var(--accent);
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
    box-shadow: 0 0 16px var(--accent-glow);
  }

  .logo-text {
    font-family: var(--mono);
    font-size: 13px;
    letter-spacing: 0.04em;
    color: var(--text);
  }

  /* ‚îÄ‚îÄ Prompt toggle ‚îÄ‚îÄ */
  .sidebar-section {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .section-label {
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 0.15em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .prompt-toggle {
    display: flex;
    gap: 6px;
  }

  .prompt-btn {
    flex: 1;
    padding: 7px 0;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted-light);
    font-family: var(--mono);
    font-size: 11px;
    cursor: pointer;
    transition: all 0.18s ease;
    letter-spacing: 0.05em;
  }

  .prompt-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .prompt-btn.active {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
    box-shadow: 0 0 12px var(--accent-glow);
  }

  .prompt-desc {
    margin-top: 8px;
    font-size: 11px;
    color: var(--muted);
    line-height: 1.5;
    min-height: 32px;
    transition: opacity 0.2s;
  }

  /* ‚îÄ‚îÄ Files panel ‚îÄ‚îÄ */
  #files-section {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    padding: 16px 0 0;
  }

  .files-label {
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 0.15em;
    color: var(--muted);
    text-transform: uppercase;
    padding: 0 20px 10px;
  }

  #files-list {
    flex: 1;
    overflow-y: auto;
    padding: 0 12px 16px;
  }

  #files-list::-webkit-scrollbar { width: 3px; }
  #files-list::-webkit-scrollbar-track { background: transparent; }
  #files-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .file-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 6px;
    cursor: default;
    transition: background 0.14s;
    margin-bottom: 1px;
  }

  .file-item:hover {
    background: var(--card);
  }

  .file-icon { font-size: 13px; flex-shrink: 0; }

  .file-name {
    font-size: 12px;
    color: var(--muted-light);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }

  .files-empty {
    padding: 8px 8px;
    font-size: 12px;
    color: var(--muted);
    font-style: italic;
  }

  /* ‚îÄ‚îÄ Main panel ‚îÄ‚îÄ */
  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
    z-index: 1;
    overflow: hidden;
    position: relative;
  }

  /* ‚îÄ‚îÄ Chat header ‚îÄ‚îÄ */
  #chat-header {
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(13,13,13,0.7);
    backdrop-filter: blur(8px);
  }

  .chat-title {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.08em;
  }

  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #3ecf8e;
    box-shadow: 0 0 8px #3ecf8e;
  }

  /* ‚îÄ‚îÄ Messages ‚îÄ‚îÄ */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px 24px 16px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  #messages::-webkit-scrollbar { width: 4px; }
  #messages::-webkit-scrollbar-track { background: transparent; }
  #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
  #empty-state {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    opacity: 0.4;
    pointer-events: none;
    margin-top: -60px;
  }

  .empty-icon {
    font-size: 40px;
    filter: grayscale(0.5);
  }

  .empty-text {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 0.06em;
  }

  /* ‚îÄ‚îÄ Message bubbles ‚îÄ‚îÄ */
  .msg {
    display: flex;
    flex-direction: column;
    animation: msgIn 0.22s ease both;
    max-width: 80%;
  }

  @keyframes msgIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .msg.user { align-self: flex-end; align-items: flex-end; }
  .msg.agent { align-self: flex-start; align-items: flex-start; }

  .msg-role {
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 5px;
    padding: 0 4px;
  }

  .msg.user .msg-role { color: var(--accent); }

  .msg-bubble {
    padding: 12px 16px;
    border-radius: var(--radius);
    line-height: 1.65;
    font-size: 13.5px;
  }

  .msg.user .msg-bubble {
    background: var(--accent-dim);
    border: 1px solid rgba(79,142,247,0.3);
    color: var(--text);
    border-bottom-right-radius: 3px;
  }

  .msg.agent .msg-bubble {
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text);
    border-bottom-left-radius: 3px;
  }

  /* markdown styles inside agent bubble */
  .msg-bubble h1,.msg-bubble h2,.msg-bubble h3 {
    margin: 12px 0 6px;
    font-family: var(--sans);
    font-weight: 500;
    color: var(--text);
  }
  .msg-bubble h1 { font-size: 17px; }
  .msg-bubble h2 { font-size: 15px; }
  .msg-bubble h3 { font-size: 13.5px; }
  .msg-bubble p { margin: 6px 0; }
  .msg-bubble ul,.msg-bubble ol { padding-left: 20px; margin: 6px 0; }
  .msg-bubble li { margin: 3px 0; }
  .msg-bubble strong { font-weight: 500; color: #d0d8f0; }
  .msg-bubble em { color: var(--muted-light); }
  .msg-bubble code {
    font-family: var(--mono);
    font-size: 12px;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    padding: 1px 5px;
    border-radius: 4px;
    color: #a8c8ff;
  }
  .msg-bubble pre {
    background: rgba(0,0,0,0.4);
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 12px 14px;
    overflow-x: auto;
    margin: 10px 0;
  }
  .msg-bubble pre code {
    background: none;
    border: none;
    padding: 0;
    font-size: 12px;
    color: #c0d8ff;
  }
  .msg-bubble hr { border: none; border-top: 1px solid var(--border); margin: 10px 0; }
  .msg-bubble a { color: var(--accent); text-decoration: none; }
  .msg-bubble a:hover { text-decoration: underline; }
  .msg-bubble blockquote {
    border-left: 3px solid var(--accent);
    padding-left: 12px;
    color: var(--muted-light);
    margin: 8px 0;
  }

  /* ‚îÄ‚îÄ Stats bar ‚îÄ‚îÄ */
  .msg-stats {
    display: flex;
    gap: 14px;
    margin-top: 6px;
    padding: 0 4px;
    flex-wrap: wrap;
  }

  .stat {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 0.04em;
  }

  .stat span {
    color: var(--muted-light);
  }

  /* ‚îÄ‚îÄ Thinking indicator ‚îÄ‚îÄ */
  .thinking-msg {
    align-self: flex-start;
    animation: msgIn 0.22s ease both;
  }

  .thinking-bubble {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    border-bottom-left-radius: 3px;
    padding: 12px 18px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .thinking-label {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 0.06em;
  }

  .dots {
    display: flex;
    gap: 4px;
  }

  .dots span {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse 1.2s ease-in-out infinite;
  }

  .dots span:nth-child(2) { animation-delay: 0.2s; }
  .dots span:nth-child(3) { animation-delay: 0.4s; }

  @keyframes pulse {
    0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
  }

  /* ‚îÄ‚îÄ Input area ‚îÄ‚îÄ */
  #input-area {
    padding: 16px 24px 20px;
    border-top: 1px solid var(--border);
    background: rgba(13,13,13,0.8);
    backdrop-filter: blur(8px);
  }

  #input-wrap {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 10px 12px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  #input-wrap:focus-within {
    border-color: rgba(79,142,247,0.5);
    box-shadow: 0 0 0 3px rgba(79,142,247,0.08);
  }

  #input {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text);
    font-family: var(--sans);
    font-size: 13.5px;
    line-height: 1.5;
    resize: none;
    min-height: 22px;
    max-height: 140px;
    overflow-y: auto;
  }

  #input::placeholder { color: var(--muted); }
  #input::-webkit-scrollbar { width: 2px; }
  #input::-webkit-scrollbar-thumb { background: var(--border); }

  #send-btn {
    width: 34px;
    height: 34px;
    background: var(--accent);
    border: none;
    border-radius: 7px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.18s ease;
    box-shadow: 0 2px 10px rgba(79,142,247,0.3);
  }

  #send-btn:hover:not(:disabled) {
    background: #6ba3ff;
    box-shadow: 0 4px 16px rgba(79,142,247,0.45);
    transform: translateY(-1px);
  }

  #send-btn:disabled {
    background: var(--border);
    box-shadow: none;
    cursor: not-allowed;
  }

  #send-btn svg { display: block; }

  .hint {
    margin-top: 7px;
    font-size: 10.5px;
    color: var(--muted);
    font-family: var(--mono);
    letter-spacing: 0.03em;
    padding: 0 2px;
  }

  .hint kbd {
    display: inline-block;
    padding: 1px 5px;
    border: 1px solid var(--border);
    border-radius: 3px;
    font-size: 9px;
    background: var(--surface);
  }
</style>
</head>
<body>
<div id="app">
  <!-- Sidebar -->
  <aside id="sidebar">
    <div id="sidebar-header">
      <div class="logo">
        <div class="logo-icon">üîç</div>
        <span class="logo-text">Drive Agent</span>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="section-label">System Prompt</div>
      <div class="prompt-toggle">
        <button class="prompt-btn" id="btn-a" onclick="setPrompt('a')">Prompt A</button>
        <button class="prompt-btn active" id="btn-b" onclick="setPrompt('b')">Prompt B</button>
      </div>
      <div class="prompt-desc" id="prompt-desc">
        Optimized: explicit search order, token-efficient, cites sources.
      </div>
    </div>

    <div id="files-section">
      <div class="files-label">Recent Files</div>
      <div id="files-list">
        <div class="files-empty">Loading‚Ä¶</div>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main id="main">
    <div id="chat-header">
      <span class="chat-title">google drive ¬∑ semantic search</span>
      <div class="status-dot" title="Connected"></div>
    </div>

    <div id="messages">
      <div id="empty-state">
        <div class="empty-icon">üóÇÔ∏è</div>
        <div class="empty-text">ask anything about your drive</div>
      </div>
    </div>

    <div id="input-area">
      <div id="input-wrap">
        <textarea id="input" rows="1" placeholder="Ask about your Google Drive‚Ä¶"></textarea>
        <button id="send-btn" onclick="sendMessage()" title="Send">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
      <div class="hint">
        <kbd>Enter</kbd> to send &nbsp;¬∑&nbsp; <kbd>Shift+Enter</kbd> for newline
      </div>
    </div>
  </main>
</div>

<script>
  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  let activePrompt = 'b';
  let isThinking = false;

  const PROMPT_DESCS = {
    a: 'Baseline: general assistant, minimal strategy.',
    b: 'Optimized: explicit search order, token-efficient, cites sources.'
  };

  const MIME_ICONS = {
    'application/vnd.google-apps.document': 'üìÑ',
    'application/vnd.google-apps.spreadsheet': 'üìä',
    'application/vnd.google-apps.presentation': 'üìù',
    'application/pdf': 'üìï',
    'application/vnd.google-apps.folder': 'üìÅ',
  };

  function mimeIcon(mime) {
    return MIME_ICONS[mime] || 'üìé';
  }

  // ‚îÄ‚îÄ Prompt selector ‚îÄ‚îÄ
  function setPrompt(p) {
    activePrompt = p;
    document.getElementById('btn-a').classList.toggle('active', p === 'a');
    document.getElementById('btn-b').classList.toggle('active', p === 'b');
    document.getElementById('prompt-desc').textContent = PROMPT_DESCS[p];
  }

  // ‚îÄ‚îÄ Load files ‚îÄ‚îÄ
  async function loadFiles() {
    const list = document.getElementById('files-list');
    try {
      const res = await fetch('/files');
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      const files = data.files || [];
      if (!files.length) {
        list.innerHTML = '<div class="files-empty">No files found.</div>';
        return;
      }
      list.innerHTML = files.map(f => `
        <div class="file-item" title="${escHtml(f.name)}">
          <span class="file-icon">${mimeIcon(f.mimeType)}</span>
          <span class="file-name">${escHtml(f.name)}</span>
        </div>
      `).join('');
    } catch (e) {
      list.innerHTML = `<div class="files-empty">Failed to load files.</div>`;
    }
  }

  // ‚îÄ‚îÄ Chat ‚îÄ‚îÄ
  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function scrollBottom() {
    const m = document.getElementById('messages');
    m.scrollTop = m.scrollHeight;
  }

  function appendUserMsg(text) {
    const es = document.getElementById('empty-state');
    if (es) es.remove();

    const div = document.createElement('div');
    div.className = 'msg user';
    div.innerHTML = `
      <div class="msg-role">you</div>
      <div class="msg-bubble">${escHtml(text)}</div>
    `;
    document.getElementById('messages').appendChild(div);
    scrollBottom();
  }

  function showThinking() {
    const div = document.createElement('div');
    div.className = 'thinking-msg';
    div.id = 'thinking-indicator';
    div.innerHTML = `
      <div class="thinking-bubble">
        <span class="thinking-label">thinking</span>
        <div class="dots"><span></span><span></span><span></span></div>
      </div>
    `;
    document.getElementById('messages').appendChild(div);
    scrollBottom();
    return div;
  }

  function removeThinking() {
    const el = document.getElementById('thinking-indicator');
    if (el) el.remove();
  }

  function appendAgentMsg(answer, stats) {
    const div = document.createElement('div');
    div.className = 'msg agent';

    const statsHtml = stats ? `
      <div class="msg-stats">
        <span class="stat">in <span>${stats.input_tokens.toLocaleString()}</span> tok</span>
        <span class="stat">out <span>${stats.output_tokens.toLocaleString()}</span> tok</span>
        <span class="stat">tools <span>${stats.tool_calls}</span></span>
        <span class="stat">turns <span>${stats.turns}</span></span>
      </div>
    ` : '';

    div.innerHTML = `
      <div class="msg-role">drive agent</div>
      <div class="msg-bubble">${marked.parse(answer)}</div>
      ${statsHtml}
    `;
    document.getElementById('messages').appendChild(div);
    scrollBottom();
  }

  function appendErrorMsg(msg) {
    const div = document.createElement('div');
    div.className = 'msg agent';
    div.innerHTML = `
      <div class="msg-role">error</div>
      <div class="msg-bubble" style="border-color:#c0392b;color:#e07070;">${escHtml(msg)}</div>
    `;
    document.getElementById('messages').appendChild(div);
    scrollBottom();
  }

  function setInputDisabled(disabled) {
    document.getElementById('input').disabled = disabled;
    document.getElementById('send-btn').disabled = disabled;
    isThinking = disabled;
  }

  async function sendMessage() {
    if (isThinking) return;
    const input = document.getElementById('input');
    const question = input.value.trim();
    if (!question) return;

    input.value = '';
    input.style.height = 'auto';

    appendUserMsg(question);
    setInputDisabled(true);
    const thinkingEl = showThinking();

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, prompt: activePrompt })
      });

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        const lines = buffer.split('\n');
        buffer = lines.pop();

        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const raw = line.slice(6).trim();
          if (!raw) continue;
          try {
            const event = JSON.parse(raw);
            if (event.type === 'done') {
              removeThinking();
              const p = event.payload;
              appendAgentMsg(p.answer, {
                input_tokens: p.input_tokens,
                output_tokens: p.output_tokens,
                tool_calls: p.tool_calls,
                turns: p.turns
              });
            } else if (event.type === 'error') {
              removeThinking();
              appendErrorMsg(event.payload);
            }
          } catch {}
        }
      }
    } catch (e) {
      removeThinking();
      appendErrorMsg('Connection error: ' + e.message);
    } finally {
      setInputDisabled(false);
      document.getElementById('input').focus();
    }
  }

  // ‚îÄ‚îÄ Auto-resize textarea ‚îÄ‚îÄ
  document.getElementById('input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 140) + 'px';
  });

  document.getElementById('input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  loadFiles();
  document.getElementById('input').focus();
</script>
</body>
</html>
