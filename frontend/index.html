<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drive Agent</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* â”€â”€ Themes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root[data-theme="dark"] {
  --bg:        #000000;
  --surface:   #0a0a0a;
  --raised:    #111111;
  --border:    #1c1c1c;
  --border-2:  #272727;
  --text:      #efefef;
  --text-2:    #808080;
  --text-3:    #333333;
  --accent:    #2563eb;
  --accent-bg: rgba(37,99,235,0.07);
  --accent-bd: rgba(37,99,235,0.2);
  --green:     #22c55e;
  --red:       #ef4444;
  --shadow:    0 0 0 1px rgba(255,255,255,0.04);
  --theme-icon: 'â˜€';
}
:root[data-theme="light"] {
  --bg:        #ffffff;
  --surface:   #fafafa;
  --raised:    #f2f2f2;
  --border:    #e8e8e8;
  --border-2:  #d4d4d4;
  --text:      #0a0a0a;
  --text-2:    #606060;
  --text-3:    #b8b8b8;
  --accent:    #2563eb;
  --accent-bg: rgba(37,99,235,0.06);
  --accent-bd: rgba(37,99,235,0.18);
  --green:     #16a34a;
  --red:       #dc2626;
  --shadow:    0 0 0 1px rgba(0,0,0,0.04);
  --theme-icon: 'â—';
}

html, body {
  height: 100%; background: var(--bg); color: var(--text);
  font-family: 'Inter', system-ui, sans-serif; font-size: 13px;
  line-height: 1.5; overflow: hidden; -webkit-font-smoothing: antialiased;
  transition: background 0.15s, color 0.15s;
}

/* â”€â”€ Login screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen {
  position: fixed; inset: 0; background: var(--bg);
  display: flex; align-items: center; justify-content: center; z-index: 100;
}
#login-screen.hidden { display: none; }
.login-card {
  display: flex; flex-direction: column; align-items: center; gap: 18px;
  padding: 44px 40px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 8px; width: 320px; box-shadow: var(--shadow);
}
.login-logo {
  width: 36px; height: 36px; background: var(--accent); border-radius: 8px;
  display: flex; align-items: center; justify-content: center; font-size: 16px;
}
.login-title { font-size: 15px; font-weight: 600; letter-spacing: -0.03em; }
.login-sub {
  font-size: 12px; color: var(--text-2); text-align: center;
  line-height: 1.6; font-weight: 400; max-width: 240px;
}
.login-btn {
  width: 100%; padding: 9px 0; background: var(--accent); border: none;
  border-radius: 5px; color: #fff; font-family: 'Inter', sans-serif;
  font-size: 12.5px; font-weight: 500; cursor: pointer;
  letter-spacing: -0.01em; transition: opacity 0.12s;
}
.login-btn:hover { opacity: 0.86; }

/* â”€â”€ App shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app { display: flex; flex-direction: column; height: 100vh; }
#app.hidden { display: none; }

/* â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#topbar {
  height: 44px; display: flex; align-items: center;
  justify-content: space-between; padding: 0 16px;
  border-bottom: 1px solid var(--border); flex-shrink: 0;
  position: relative; z-index: 10; background: var(--bg);
  transition: border-color 0.15s;
}
.brand { display: flex; align-items: center; gap: 8px; }
.brand-icon {
  width: 20px; height: 20px; background: var(--accent); border-radius: 4px;
  display: flex; align-items: center; justify-content: center; font-size: 10px;
}
.brand-name { font-size: 12.5px; font-weight: 600; letter-spacing: -0.02em; }
.tab-row {
  display: flex; gap: 1px; position: absolute; left: 50%; transform: translateX(-50%);
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; padding: 2px;
}
.tab-btn {
  padding: 4px 14px; border: none; background: none; border-radius: 4px;
  color: var(--text-2); font-family: 'Inter', sans-serif; font-size: 11.5px;
  font-weight: 500; cursor: pointer; transition: all 0.1s; letter-spacing: -0.01em;
}
.tab-btn:hover:not(.active) { color: var(--text); }
.tab-btn.active { background: var(--raised); color: var(--text); box-shadow: var(--shadow); }
.topbar-right { display: flex; align-items: center; gap: 10px; }
.user-email { font-size: 10.5px; color: var(--text-2); font-family: 'JetBrains Mono', monospace; }
.topbar-btn {
  padding: 4px 9px; border: 1px solid var(--border); background: none;
  border-radius: 4px; color: var(--text-2); font-size: 11px; cursor: pointer;
  transition: all 0.1s; font-family: 'Inter', sans-serif; font-weight: 500;
}
.topbar-btn:hover { color: var(--text); border-color: var(--border-2); }
#theme-btn { font-size: 13px; padding: 3px 8px; }

/* â”€â”€ Tab panes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tab-pane { display: none; flex: 1; overflow: hidden; min-height: 0; }
.tab-pane.active { display: flex; }

/* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar {
  width: 216px; min-width: 216px; background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
  transition: background 0.15s, border-color 0.15s;
}
.sb-block {
  padding: 12px 12px 10px; border-bottom: 1px solid var(--border);
  transition: border-color 0.15s;
}
.sb-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--text-3); margin-bottom: 7px;
  transition: color 0.15s;
}
.sys-prompt-ta {
  width: 100%; background: var(--raised); border: 1px solid var(--border);
  border-radius: 4px; color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 9.5px; line-height: 1.55; padding: 6px 8px; resize: vertical;
  min-height: 80px; outline: none; transition: border-color 0.12s, background 0.15s;
}
.sys-prompt-ta:focus { border-color: var(--accent); }
.reset-btn {
  margin-top: 5px; font-size: 9px; color: var(--text-3); background: none;
  border: none; cursor: pointer; padding: 0; font-family: 'Inter', sans-serif;
  transition: color 0.1s;
}
.reset-btn:hover { color: var(--text-2); }
.model-select {
  width: 100%; background: var(--raised); border: 1px solid var(--border);
  border-radius: 4px; color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 10px; padding: 5px 26px 5px 7px; outline: none; cursor: pointer;
  transition: border-color 0.12s, background 0.15s; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='9' height='5'%3E%3Cpath d='M0 0l4.5 5L9 0z' fill='%23555'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 8px center;
}
.model-select:focus { border-color: var(--accent); }
.sb-files-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--text-3);
  padding: 11px 12px 5px; transition: color 0.15s;
}
#files-scroll { flex: 1; overflow-y: auto; padding: 2px 6px 10px; }
#files-scroll::-webkit-scrollbar { width: 2px; }
#files-scroll::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 1px; }
.file-row {
  display: flex; align-items: center; gap: 6px; padding: 4px 6px;
  border-radius: 4px; cursor: default; transition: background 0.08s;
}
.file-row:hover { background: var(--raised); }
.f-icon { font-size: 11px; flex-shrink: 0; }
.f-name { font-size: 11px; color: var(--text-2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* â”€â”€ Chat main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#chat-main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
#messages {
  flex: 1; overflow-y: auto; padding: 32px 36px 16px;
  display: flex; flex-direction: column; gap: 22px;
}
#messages::-webkit-scrollbar { width: 3px; }
#messages::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 2px; }
#empty-state {
  flex: 1; display: flex; align-items: center; justify-content: center;
  flex-direction: column; gap: 6px; color: var(--text-3); margin-top: -80px;
}
.empty-icon { font-size: 24px; opacity: 0.5; }
.empty-hint { font-size: 11px; letter-spacing: 0.01em; color: var(--text-3); }
.msg { display: flex; flex-direction: column; max-width: 76%; animation: fadeUp 0.15s ease both; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
.msg.user { align-self: flex-end; align-items: flex-end; }
.msg.agent { align-self: flex-start; align-items: flex-start; }
.msg-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--text-3); margin-bottom: 4px; padding: 0 1px;
}
.msg.user .msg-label { color: var(--accent); opacity: 0.7; }
.bubble {
  padding: 10px 14px; border-radius: 6px; line-height: 1.7;
  font-size: 13px; font-weight: 400;
}
.msg.user .bubble {
  background: var(--accent-bg); border: 1px solid var(--accent-bd);
  color: var(--text); border-bottom-right-radius: 2px;
}
.msg.agent .bubble {
  background: var(--surface); border: 1px solid var(--border);
  color: var(--text); border-bottom-left-radius: 2px;
}
.bubble h1,.bubble h2,.bubble h3 { margin: 10px 0 4px; font-weight: 600; }
.bubble h1 { font-size: 15px; } .bubble h2 { font-size: 14px; } .bubble h3 { font-size: 13px; }
.bubble p { margin: 4px 0; }
.bubble ul,.bubble ol { padding-left: 16px; margin: 4px 0; }
.bubble li { margin: 2px 0; }
.bubble strong { font-weight: 600; }
.bubble code {
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  background: var(--raised); border: 1px solid var(--border);
  padding: 1px 5px; border-radius: 3px; color: var(--accent);
}
.bubble pre {
  background: var(--raised); border: 1px solid var(--border);
  border-radius: 4px; padding: 12px; overflow-x: auto; margin: 8px 0;
}
.bubble pre code { background: none; border: none; padding: 0; font-size: 11.5px; color: var(--text-2); }
.bubble a { color: var(--accent); text-decoration: none; }
.bubble a:hover { text-decoration: underline; }
.bubble hr { border: none; border-top: 1px solid var(--border); margin: 8px 0; }
.bubble blockquote { border-left: 2px solid var(--border-2); padding-left: 10px; color: var(--text-2); margin: 5px 0; }
.msg-stats { display: flex; gap: 10px; margin-top: 5px; padding: 0 1px; }
.stat-item { font-family: 'JetBrains Mono', monospace; font-size: 9.5px; color: var(--text-3); }
.stat-item b { color: var(--text-2); font-weight: 500; }
.thinking { align-self: flex-start; animation: fadeUp 0.15s ease both; }
.thinking-inner {
  display: flex; align-items: center; gap: 8px; padding: 8px 12px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; border-bottom-left-radius: 2px;
}
.thinking-text { font-size: 11px; color: var(--text-2); font-family: 'JetBrains Mono', monospace; }
.dots span {
  display: inline-block; width: 3.5px; height: 3.5px; border-radius: 50%;
  background: var(--accent); animation: blink 1.2s ease-in-out infinite; margin: 0 1.5px;
}
.dots span:nth-child(2) { animation-delay: 0.2s; }
.dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%,80%,100%{opacity:.15;transform:scale(.75)} 40%{opacity:1;transform:scale(1)} }
#input-area { padding: 8px 36px 16px; border-top: 1px solid var(--border); transition: border-color 0.15s; }
#input-row {
  display: flex; align-items: flex-end; gap: 7px;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 6px; padding: 7px 9px;
  transition: border-color 0.12s, background 0.15s;
}
#input-row:focus-within { border-color: var(--border-2); }
#chat-input {
  flex: 1; background: none; border: none; outline: none; color: var(--text);
  font-family: 'Inter', sans-serif; font-size: 13px; font-weight: 400;
  line-height: 1.5; resize: none; min-height: 20px; max-height: 120px;
}
#chat-input::placeholder { color: var(--text-3); }
#send-btn {
  width: 28px; height: 28px; background: var(--accent); border: none;
  border-radius: 4px; cursor: pointer; display: flex; align-items: center;
  justify-content: center; flex-shrink: 0; transition: opacity 0.1s, transform 0.1s;
}
#send-btn:hover:not(:disabled) { opacity: 0.84; transform: translateY(-1px); }
#send-btn:disabled { background: var(--border-2); cursor: not-allowed; transform: none; }
.input-hint { margin-top: 4px; font-size: 10px; color: var(--text-3); }
.input-hint kbd {
  display: inline-block; padding: 0 3px; border: 1px solid var(--border);
  border-radius: 3px; background: var(--surface); font-size: 9px;
  font-family: 'Inter', sans-serif;
}

/* â”€â”€ Eval tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#tab-eval { background: var(--bg); overflow-y: auto; transition: background 0.15s; }
#eval-wrap { max-width: 820px; margin: 0 auto; padding: 32px 32px 80px; }
.eval-head { margin-bottom: 22px; }
.eval-title { font-size: 16px; font-weight: 600; letter-spacing: -0.03em; margin-bottom: 3px; }
.eval-sub { font-size: 11.5px; color: var(--text-2); font-weight: 400; }
.eval-section { margin-bottom: 20px; }
.eval-section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px; flex-wrap: wrap; gap: 8px;
}
.eval-section-left { display: flex; align-items: baseline; gap: 8px; }
.q-badge {
  font-size: 9.5px; font-family: 'JetBrains Mono', monospace;
  color: var(--text-3); background: var(--raised); border: 1px solid var(--border);
  border-radius: 3px; padding: 1px 6px;
}
.eval-section-right { display: flex; align-items: center; gap: 7px; }
.gen-btn {
  padding: 5px 11px; background: none; border: 1px solid var(--border);
  border-radius: 4px; color: var(--text-2); font-family: 'Inter', sans-serif;
  font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.1s;
}
.gen-btn:hover:not(:disabled) { color: var(--text); border-color: var(--border-2); }
.gen-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.save-btn {
  padding: 5px 11px; background: none; border: 1px solid var(--border);
  border-radius: 4px; color: var(--green); font-family: 'Inter', sans-serif;
  font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.1s;
}
.save-btn:hover { border-color: var(--green); }
#gen-status { font-family: 'JetBrains Mono', monospace; font-size: 9.5px; color: var(--text-2); }
.questions-ta {
  width: 100%; background: var(--surface); border: 1px solid var(--border);
  border-radius: 4px; color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 10px; line-height: 1.55; padding: 10px 11px;
  resize: vertical; min-height: 110px; outline: none;
  transition: border-color 0.12s, background 0.15s;
}
.questions-ta:focus { border-color: var(--accent); }
.eval-prompt-block { margin-bottom: 14px; }
.eval-prompt-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--text-3); margin-bottom: 6px;
}
.eval-prompt-ta {
  width: 100%; background: var(--surface); border: 1px solid var(--border);
  border-radius: 4px; color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 10.5px; line-height: 1.55; padding: 10px 11px;
  resize: vertical; min-height: 88px; outline: none;
  transition: border-color 0.12s, background 0.15s;
}
.eval-prompt-ta:focus { border-color: var(--accent); }
.compare-toggle-btn {
  font-size: 11px; color: var(--text-2); background: none;
  border: 1px dashed var(--border-2); border-radius: 4px;
  cursor: pointer; padding: 5px 12px; margin-bottom: 14px;
  font-family: 'Inter', sans-serif; font-weight: 500;
  transition: all 0.1s; display: inline-block;
}
.compare-toggle-btn:hover { color: var(--text); border-color: var(--text-3); }
.eval-controls { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; }
.eval-model-row { display: flex; align-items: center; gap: 8px; }
.eval-model-label {
  font-size: 9px; font-weight: 600; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--text-3); white-space: nowrap;
}
#run-btn {
  padding: 6px 14px; background: var(--accent); border: none; border-radius: 4px;
  color: #fff; font-family: 'Inter', sans-serif; font-size: 11.5px; font-weight: 600;
  cursor: pointer; transition: opacity 0.1s; letter-spacing: -0.01em;
}
#run-btn:hover:not(:disabled) { opacity: 0.84; }
#run-btn:disabled { opacity: 0.35; cursor: not-allowed; }
#eval-status-txt { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-2); }
.table-wrap {
  border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
  transition: border-color 0.15s;
}
.eval-tbl { width: 100%; border-collapse: collapse; font-size: 11.5px; }
.eval-tbl th {
  padding: 8px 12px; text-align: left; font-family: 'JetBrains Mono', monospace;
  font-size: 9px; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--text-3); background: var(--surface); border-bottom: 1px solid var(--border);
  white-space: nowrap; transition: background 0.15s, border-color 0.15s;
}
.eval-tbl th.r { text-align: right; }
.eval-tbl td { padding: 7px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; transition: border-color 0.15s; }
.eval-tbl tr:last-child td { border-bottom: none; }
.eval-tbl tr:hover td { background: var(--surface); }
.td-id { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: var(--text-3); }
.td-q { color: var(--text-2); max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.td-p { font-family: 'JetBrains Mono', monospace; font-size: 10px; white-space: nowrap; }
.td-p.p1 { color: #60a5fa; } .td-p.p2 { color: #c084fc; }
.td-ok { font-size: 11.5px; }
.td-n { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-2); text-align: right; white-space: nowrap; }
.td-n.better { color: var(--green); } .td-n.worse { color: var(--red); }
.sum-row td { background: var(--raised); border-top: 1px solid var(--border-2); }
.sum-row .td-n { color: var(--text); }
.tbl-empty { padding: 36px 0; text-align: center; color: var(--text-3); font-family: 'JetBrains Mono', monospace; font-size: 10.5px; }
</style>
</head>
<body>

<!-- â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen">
  <div class="login-card">
    <div class="login-logo">âŒ–</div>
    <div class="login-title">Drive Agent</div>
    <div class="login-sub">Search and query your Google Drive files with AI.</div>
    <button class="login-btn" onclick="location.href='/auth/login'">Sign in with Google</button>
  </div>
</div>

<!-- â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app" class="hidden">

  <div id="topbar">
    <div class="brand">
      <div class="brand-icon">âŒ–</div>
      <span class="brand-name">Drive Agent</span>
    </div>
    <div class="tab-row">
      <button class="tab-btn active" onclick="switchTab('chat')">Chat</button>
      <button class="tab-btn" onclick="switchTab('eval')">Eval</button>
    </div>
    <div class="topbar-right">
      <span class="user-email" id="user-email"></span>
      <button id="theme-btn" class="topbar-btn" onclick="toggleTheme()" title="Toggle theme">â—</button>
      <button class="topbar-btn" onclick="location.href='/auth/logout'">Sign out</button>
    </div>
  </div>

  <!-- CHAT TAB -->
  <div id="tab-chat" class="tab-pane active">
    <aside id="sidebar">
      <div class="sb-block">
        <div class="sb-label">Model</div>
        <select id="chat-model" class="model-select">
          <option value="claude-sonnet-4-6">Sonnet 4.6</option>
          <option value="claude-haiku-4-5-20251001">Haiku 4.5</option>
          <option value="claude-opus-4-6">Opus 4.6</option>
        </select>
      </div>
      <div class="sb-block">
        <div class="sb-label">System Prompt</div>
        <textarea id="system-prompt-input" class="sys-prompt-ta" spellcheck="false"></textarea>
        <button class="reset-btn" onclick="resetPrompt()">Reset to default</button>
      </div>
      <div class="sb-files-label">Recent Files</div>
      <div id="files-scroll">
        <div style="font-size:10.5px;color:var(--text-3);padding:6px 6px;">Loadingâ€¦</div>
      </div>
    </aside>

    <main id="chat-main">
      <div id="messages">
        <div id="empty-state">
          <div class="empty-icon">ğŸ—‚</div>
          <div class="empty-hint">ask anything about your google drive</div>
        </div>
      </div>
      <div id="input-area">
        <div id="input-row">
          <textarea id="chat-input" rows="1" placeholder="Ask about your Driveâ€¦"></textarea>
          <button id="send-btn" onclick="sendMessage()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
        <div class="input-hint"><kbd>Enter</kbd> send Â· <kbd>Shift+Enter</kbd> newline</div>
      </div>
    </main>
  </div>

  <!-- EVAL TAB -->
  <div id="tab-eval" class="tab-pane">
    <div id="eval-wrap">
      <div class="eval-head">
        <div class="eval-title">Eval Runner</div>
        <div class="eval-sub">Test 1 or 2 system prompts against your question set and compare token cost and accuracy.</div>
      </div>

      <!-- Question set -->
      <div class="eval-section">
        <div class="eval-section-header">
          <div class="eval-section-left">
            <div class="eval-prompt-label">Question Set</div>
            <span id="q-badge" class="q-badge">loadingâ€¦</span>
          </div>
          <div class="eval-section-right">
            <span id="gen-status"></span>
            <select id="gen-count" class="model-select" style="width:auto">
              <option value="3">3 Qs</option>
              <option value="5" selected>5 Qs</option>
              <option value="10">10 Qs</option>
            </select>
            <button class="gen-btn" id="gen-btn" onclick="generateQuestions()">Generate with AI</button>
            <button class="save-btn" onclick="saveQuestions()">Save</button>
          </div>
        </div>
        <textarea id="questions-ta" class="questions-ta" spellcheck="false"></textarea>
      </div>
      <hr style="border:none;border-top:1px solid var(--border);margin-bottom:20px">

      <div class="eval-prompt-block">
        <div class="eval-prompt-label">Prompt 1</div>
        <textarea id="eval-p1" class="eval-prompt-ta" spellcheck="false"></textarea>
      </div>

      <button class="compare-toggle-btn" id="compare-btn" onclick="toggleCompare()">+ Compare with a second prompt</button>

      <div class="eval-prompt-block" id="eval-p2-block" style="display:none">
        <div class="eval-prompt-label">Prompt 2</div>
        <textarea id="eval-p2" class="eval-prompt-ta" spellcheck="false" placeholder="Enter a different system prompt to compareâ€¦"></textarea>
      </div>

      <div class="eval-controls">
        <button id="run-btn" onclick="runEval()">Run Eval</button>
        <div class="eval-model-row">
          <span class="eval-model-label">Model</span>
          <select id="eval-model" class="model-select" style="width:auto;min-width:148px">
            <option value="claude-sonnet-4-6">Sonnet 4.6</option>
            <option value="claude-haiku-4-5-20251001">Haiku 4.5</option>
            <option value="claude-opus-4-6">Opus 4.6</option>
          </select>
        </div>
        <span id="eval-status-txt"></span>
      </div>

      <div class="table-wrap">
        <table class="eval-tbl">
          <thead>
            <tr>
              <th>ID</th><th>Question</th><th>Prompt</th><th>Pass</th>
              <th class="r">In Tok</th><th class="r">Out Tok</th>
              <th class="r">Tools</th><th class="r">Turns</th>
            </tr>
          </thead>
          <tbody id="eval-tbody">
            <tr><td colspan="8" class="tbl-empty">Run an eval to see results.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
// â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const html = document.documentElement;
  const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
  html.dataset.theme = next;
  document.getElementById('theme-btn').textContent = next === 'dark' ? 'â—' : 'â˜€';
  localStorage.setItem('theme', next);
}
(function() {
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.dataset.theme = saved;
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('theme-btn');
    if (btn) btn.textContent = saved === 'dark' ? 'â—' : 'â˜€';
  });
})();

// â”€â”€ Default prompt (mirrors agent/prompts.py) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_PROMPT = `You are a precise research assistant with access to Google Drive.

Rules you must follow:
1. Always use search_drive first with specific keywords before using list_files.
2. Before calling read_document, state which file you believe contains the answer and why.
3. Read at most 2 documents per question â€” choose the most likely candidates.
4. If the answer is visible in search result metadata (file names, snippets), answer without reading.
5. Give concise answers and always cite the source file name.`;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chatBusy = false, evalRunning = false, compareMode = false;
let evalResults = { "1": [], "2": [] };

const ICONS = {
  'application/vnd.google-apps.document': 'ğŸ“„',
  'application/vnd.google-apps.spreadsheet': 'ğŸ“Š',
  'application/vnd.google-apps.presentation': 'ğŸ“',
  'application/pdf': 'ğŸ“•',
  'application/vnd.google-apps.folder': 'ğŸ“',
};
const icon = m => ICONS[m] || 'ğŸ“';

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  document.getElementById('system-prompt-input').value = DEFAULT_PROMPT;
  document.getElementById('eval-p1').value = DEFAULT_PROMPT;

  const res = await fetch('/auth/status');
  const data = await res.json();
  if (!data.authenticated) {
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
  } else {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('user-email').textContent = data.email || '';
    loadFiles();
    loadQuestions();
    document.getElementById('chat-input').focus();
  }
}

// â”€â”€ Questions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _setQBadge(questions) {
  document.getElementById('q-badge').textContent = `${questions.length} question${questions.length !== 1 ? 's' : ''}`;
}

async function loadQuestions() {
  try {
    const r = await fetch('/eval/questions');
    const d = await r.json();
    const qs = d.questions || [];
    document.getElementById('questions-ta').value = JSON.stringify(qs, null, 2);
    _setQBadge(qs);
  } catch {
    document.getElementById('q-badge').textContent = 'error';
  }
}

async function saveQuestions() {
  const ta = document.getElementById('questions-ta');
  let qs;
  try { qs = JSON.parse(ta.value); } catch { alert('Invalid JSON in question set.'); return; }
  try {
    const r = await fetch('/eval/questions', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ questions: qs })
    });
    const d = await r.json();
    if (d.error) { alert('Save failed: ' + d.error); return; }
    _setQBadge(qs);
    const btn = document.querySelector('.save-btn');
    const orig = btn.textContent; btn.textContent = 'Saved âœ“';
    setTimeout(() => btn.textContent = orig, 1500);
  } catch (e) { alert('Save error: ' + e.message); }
}

async function generateQuestions() {
  const genBtn = document.getElementById('gen-btn');
  const status = document.getElementById('gen-status');
  const count = document.getElementById('gen-count').value;
  const model = document.getElementById('eval-model').value;
  genBtn.disabled = true;
  status.textContent = 'generatingâ€¦';
  try {
    const res = await fetch('/eval/generate-questions', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ count: parseInt(count), model })
    });
    const reader = res.body.getReader(), dec = new TextDecoder();
    let buf = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });
      const lines = buf.split('\n'); buf = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const ev = JSON.parse(line.slice(6));
          if (ev.type === 'thinking') { status.textContent = 'browsing driveâ€¦'; }
          else if (ev.type === 'done') {
            const qs = ev.questions;
            document.getElementById('questions-ta').value = JSON.stringify(qs, null, 2);
            _setQBadge(qs);
            const t = ev.tokens;
            status.textContent = `done Â· ${t?.input_tokens?.toLocaleString()} in / ${t?.output_tokens?.toLocaleString()} out`;
          } else if (ev.type === 'error') {
            status.textContent = 'error: ' + ev.payload;
          }
        } catch {}
      }
    }
  } catch (e) { status.textContent = 'error: ' + e.message; }
  finally { genBtn.disabled = false; }
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(t) {
  document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + t).classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(el => {
    if (el.textContent.toLowerCase() === t) el.classList.add('active');
  });
}

// â”€â”€ Prompt helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetPrompt() {
  document.getElementById('system-prompt-input').value = DEFAULT_PROMPT;
}

function toggleCompare() {
  compareMode = !compareMode;
  document.getElementById('eval-p2-block').style.display = compareMode ? '' : 'none';
  document.getElementById('compare-btn').textContent = compareMode
    ? 'âˆ’ Remove second prompt'
    : '+ Compare with a second prompt';
}

// â”€â”€ Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function loadFiles() {
  const el = document.getElementById('files-scroll');
  try {
    const r = await fetch('/files');
    if (r.status === 401) { el.innerHTML = ''; return; }
    const d = await r.json();
    const files = d.files || [];
    if (!files.length) { el.innerHTML = '<div style="font-size:10.5px;color:var(--text-3);padding:6px">No files.</div>'; return; }
    el.innerHTML = files.map(f => `
      <div class="file-row" title="${esc(f.name)}">
        <span class="f-icon">${icon(f.mimeType)}</span>
        <span class="f-name">${esc(f.name)}</span>
      </div>`).join('');
  } catch {
    el.innerHTML = '<div style="font-size:10.5px;color:var(--text-3);padding:6px">Error loading.</div>';
  }
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollBottom() { const m = document.getElementById('messages'); m.scrollTop = m.scrollHeight; }

function appendUser(text) {
  document.getElementById('empty-state')?.remove();
  const d = document.createElement('div');
  d.className = 'msg user';
  d.innerHTML = `<div class="msg-label">you</div><div class="bubble">${esc(text)}</div>`;
  document.getElementById('messages').appendChild(d);
  scrollBottom();
}

function showThinking() {
  const d = document.createElement('div');
  d.className = 'thinking'; d.id = 'thinking';
  d.innerHTML = `<div class="thinking-inner">
    <span class="thinking-text">thinking</span>
    <div class="dots"><span></span><span></span><span></span></div>
  </div>`;
  document.getElementById('messages').appendChild(d);
  scrollBottom();
}

function removeThinking() { document.getElementById('thinking')?.remove(); }

function appendAgent(answer, stats) {
  const statsHtml = stats ? `<div class="msg-stats">
    <span class="stat-item"><b>${stats.input_tokens.toLocaleString()}</b> in</span>
    <span class="stat-item"><b>${stats.output_tokens.toLocaleString()}</b> out</span>
    <span class="stat-item"><b>${stats.tool_calls}</b> tools</span>
    <span class="stat-item"><b>${stats.turns}</b> turns</span>
  </div>` : '';
  const d = document.createElement('div');
  d.className = 'msg agent';
  d.innerHTML = `<div class="msg-label">agent</div><div class="bubble">${marked.parse(answer)}</div>${statsHtml}`;
  document.getElementById('messages').appendChild(d);
  scrollBottom();
}

function appendError(msg) {
  const d = document.createElement('div');
  d.className = 'msg agent';
  d.innerHTML = `<div class="msg-label" style="color:var(--red)">error</div>
    <div class="bubble" style="border-color:color-mix(in srgb,var(--red) 25%,transparent);color:var(--red)">${esc(msg)}</div>`;
  document.getElementById('messages').appendChild(d);
  scrollBottom();
}

function setDisabled(v) {
  chatBusy = v;
  document.getElementById('chat-input').disabled = v;
  document.getElementById('send-btn').disabled = v;
}

async function sendMessage() {
  if (chatBusy) return;
  const input = document.getElementById('chat-input');
  const q = input.value.trim();
  if (!q) return;
  const systemPrompt = document.getElementById('system-prompt-input').value.trim() || DEFAULT_PROMPT;
  const model = document.getElementById('chat-model').value;
  input.value = ''; input.style.height = 'auto';
  appendUser(q); setDisabled(true); showThinking();
  try {
    const res = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question: q, system_prompt: systemPrompt, model })
    });
    if (res.status === 401) { removeThinking(); appendError('Session expired. Please sign in again.'); setDisabled(false); return; }
    const reader = res.body.getReader(), dec = new TextDecoder();
    let buf = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });
      const lines = buf.split('\n'); buf = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const ev = JSON.parse(line.slice(6));
          if (ev.type === 'done') { removeThinking(); appendAgent(ev.payload.answer, ev.payload); }
          else if (ev.type === 'error') { removeThinking(); appendError(ev.payload); }
        } catch {}
      }
    }
  } catch (e) { removeThinking(); appendError('Connection error: ' + e.message); }
  finally { setDisabled(false); document.getElementById('chat-input').focus(); }
}

// â”€â”€ Eval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cmp(val, other) {
  if (val == null || other == null) return '';
  return val < other ? 'better' : val > other ? 'worse' : '';
}

function renderTable() {
  const tbody = document.getElementById('eval-tbody');
  const r1 = evalResults["1"], r2 = evalResults["2"];
  const ids = [...new Set([...r1, ...r2].map(r => r.id))];
  if (!ids.length) { tbody.innerHTML = '<tr><td colspan="8" class="tbl-empty">No results yet.</td></tr>'; return; }

  let html = '';
  for (const id of ids) {
    const ra = r1.find(r => r.id === id), rb = r2.find(r => r.id === id);
    for (const [lbl, r] of [['1', ra], ['2', rb]]) {
      if (!r) continue;
      const other = lbl === '1' ? rb : ra;
      html += `<tr>
        <td class="td-id">${esc(r.id)}</td>
        <td class="td-q" title="${esc(r.question)}">${esc(r.question)}</td>
        <td class="td-p p${lbl}">${lbl}</td>
        <td class="td-ok">${r.correct ? 'âœ“' : 'âœ—'}</td>
        <td class="td-n ${cmp(r.input_tokens, other?.input_tokens)}">${r.input_tokens.toLocaleString()}</td>
        <td class="td-n ${cmp(r.output_tokens, other?.output_tokens)}">${r.output_tokens.toLocaleString()}</td>
        <td class="td-n ${cmp(r.tool_calls, other?.tool_calls)}">${r.tool_calls}</td>
        <td class="td-n ${cmp(r.turns, other?.turns)}">${r.turns}</td>
      </tr>`;
    }
  }

  const avg = (rs, k) => rs.length ? rs.reduce((s,r) => s+(r[k]||0),0)/rs.length : null;
  const pct = rs => rs.length ? Math.round(rs.filter(r=>r.correct).length/rs.length*100)+'%' : 'â€”';

  for (const [lbl, rs] of [['1', r1], ['2', r2]]) {
    if (!rs.length) continue;
    const other = lbl === '1' ? r2 : r1;
    html += `<tr class="sum-row">
      <td class="td-id">avg</td>
      <td style="font-size:11px;color:var(--text-2)">Summary</td>
      <td class="td-p p${lbl}">${lbl}</td>
      <td style="font-size:11.5px;font-weight:600">${pct(rs)}</td>
      <td class="td-n ${cmp(avg(rs,'input_tokens'),avg(other,'input_tokens'))}">${Math.round(avg(rs,'input_tokens')).toLocaleString()}</td>
      <td class="td-n ${cmp(avg(rs,'output_tokens'),avg(other,'output_tokens'))}">${Math.round(avg(rs,'output_tokens')).toLocaleString()}</td>
      <td class="td-n ${cmp(avg(rs,'tool_calls'),avg(other,'tool_calls'))}">${avg(rs,'tool_calls').toFixed(1)}</td>
      <td class="td-n ${cmp(avg(rs,'turns'),avg(other,'turns'))}">${avg(rs,'turns').toFixed(1)}</td>
    </tr>`;
  }
  tbody.innerHTML = html;
}

async function runEval() {
  if (evalRunning) return;
  evalRunning = true;
  evalResults = { "1": [], "2": [] };
  document.getElementById('run-btn').disabled = true;
  document.getElementById('eval-tbody').innerHTML = '<tr><td colspan="8" class="tbl-empty">Runningâ€¦</td></tr>';
  const status = document.getElementById('eval-status-txt');
  status.textContent = 'startingâ€¦';

  const p1 = document.getElementById('eval-p1').value.trim() || DEFAULT_PROMPT;
  const prompts = [p1];
  if (compareMode) {
    const p2 = document.getElementById('eval-p2').value.trim();
    if (p2) prompts.push(p2);
  }
  const model = document.getElementById('eval-model').value;

  // Parse questions from the textarea; fall back to server-side questions.json if invalid
  let inlineQuestions = null;
  try {
    const parsed = JSON.parse(document.getElementById('questions-ta').value);
    if (Array.isArray(parsed) && parsed.length) inlineQuestions = parsed;
  } catch {}

  try {
    const res = await fetch('/eval', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompts, model, questions: inlineQuestions })
    });
    if (res.status === 401) { status.textContent = 'sign in required'; return; }
    const reader = res.body.getReader(), dec = new TextDecoder();
    let buf = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });
      const lines = buf.split('\n'); buf = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const ev = JSON.parse(line.slice(6));
          if (ev.type === 'result') {
            evalResults[ev.prompt].push(ev);
            status.textContent = `${model} Â· ${ev.id} Â· prompt ${ev.prompt} Â· ${ev.correct ? 'pass' : 'fail'}`;
            renderTable();
          } else if (ev.type === 'done') {
            status.textContent = 'complete';
          }
        } catch {}
      }
    }
  } catch (e) { status.textContent = 'error: ' + e.message; }
  finally { evalRunning = false; document.getElementById('run-btn').disabled = false; }
}

// â”€â”€ Input auto-resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('chat-input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});
document.getElementById('chat-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

init();
</script>
</body>
</html>
